<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>V·ªä TR√ç + T·ªíN KHO</title>

  <!-- ‚úÖ XLSX loader (c√≥ fallback CDN) -->
  <script>
    async function ensureXLSX(){
      if (window.XLSX) return true;
      const load = (src)=> new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = src;
        s.onload = ()=>resolve(true);
        s.onerror = ()=>reject(new Error("Load fail: " + src));
        document.head.appendChild(s);
      });
      try{
        await load("https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js");
        return !!window.XLSX;
      }catch(e1){
        try{
          await load("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js");
          return !!window.XLSX;
        }catch(e2){
          return false;
        }
      }
    }
  </script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --primary:#1976d2; --primary2:#64b5f6;
      --danger:#d32f2f; --warn:#ef6c00; --ok:#1b5e20;
      --border:#e2e8f0; --shadow: 0 10px 30px rgba(15,23,42,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(25,118,210,.18), transparent 55%),
        radial-gradient(1000px 400px at 90% 0%, rgba(100,181,246,.25), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;}
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      box-shadow:0 12px 25px rgba(25,118,210,.22);
      display:grid;place-items:center;color:#fff;font-weight:900;flex:0 0 auto;
    }
    .title h1{font-size:18px;margin:0}
    .title p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .topRight{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}

    .pill{
      padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);
      color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .ok{background:#e8f7ee;color:#14532d;border-color:rgba(27,94,32,.2)}
    .warn{background:#fff4e5;color:#7c2d12;border-color:rgba(239,108,0,.25)}
    .bad{background:#ffe8e8;color:#7f1d1d;border-color:rgba(211,50,47,.25)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    .tab{
      border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:14px;
      cursor:pointer;font-weight:900;color:#0f172a;
    }
    .tab.active{
      border-color:rgba(25,118,210,.45);
      box-shadow:0 10px 25px rgba(25,118,210,.12);
      background:linear-gradient(135deg,rgba(25,118,210,.1),rgba(100,181,246,.1));
    }

    .row{display:grid;gap:12px}
    @media (min-width:980px){ .row{grid-template-columns:1fr 1fr;} }

    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--r);
      box-shadow:var(--shadow);padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:15px;display:flex;gap:8px;align-items:center;}
    .hint{color:var(--muted);font-size:12.5px;margin:0 0 10px;}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;}

    input,select,textarea{
      width:100%;border:1px solid var(--border);background:#fff;border-radius:14px;
      padding:12px 12px;font-size:15px;outline:none;transition:.15s;
    }
    textarea{min-height:140px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:rgba(25,118,210,.65);
      box-shadow:0 0 0 4px rgba(25,118,210,.12)
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{
      border:0;border-radius:14px;padding:11px 12px;font-weight:900;cursor:pointer;
      background:#eaf2ff;color:#0b3b7a;
    }
    button.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;box-shadow:0 12px 25px rgba(25,118,210,.22);}
    button.ghost{background:#f1f5f9;color:#0f172a;}
    button.danger{background:#ffe8e8;color:#7f1d1d;}
    button:active{transform:translateY(1px)}
    .divider{height:1px;background:var(--border);margin:12px 0;}

    .list{display:grid;gap:10px;}
    .item{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff;display:grid;gap:10px;}
    .itemTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;}
    .name{font-weight:900;font-size:15px;line-height:1.25;}
    .meta{margin-top:4px;color:var(--muted);font-size:12.5px;}
    .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}
    .actions button{padding:9px 10px;border-radius:12px;font-weight:900;font-size:13px;}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    .grid2{display:grid;gap:10px;grid-template-columns:1fr;}
    @media (min-width:520px){ .grid2{grid-template-columns:1fr 1fr;} }

    .tag{
      display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:#f8fafc;font-size:12px;color:var(--muted);font-weight:900;
    }
    .tag strong{color:#0f172a}

    /* Tray Grid */
    .gridWrap{border:1px solid var(--border);border-radius:18px;background:#fff;padding:12px;}
    .gridHead{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px;}
    .gridHead .left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .gridHead .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
    @media (min-width:520px){ .grid{grid-template-columns:repeat(6,1fr);} }
    @media (min-width:820px){ .grid{grid-template-columns:repeat(8,1fr);} }

    .cell{
      border:1px solid var(--border);border-radius:14px;padding:10px 10px;background:#f8fafc;cursor:pointer;
      min-height:64px;display:flex;flex-direction:column;gap:6px;justify-content:space-between;
    }
    .cell .pos{font-size:12px;color:var(--muted);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .badge{
      font-size:11px;font-weight:900;padding:2px 8px;border-radius:999px;border:1px solid var(--border);
      background:#fff;color:var(--muted);white-space:nowrap;
    }
    .badge.ok{background:#e8f7ee;color:#14532d;border-color:rgba(27,94,32,.2)}
    .badge.warn{background:#fff4e5;color:#7c2d12;border-color:rgba(239,108,0,.25)}
    .badge.bad{background:#ffe8e8;color:#7f1d1d;border-color:rgba(211,50,47,.25)}

    .cell .pname{
      font-size:12.5px;font-weight:900;line-height:1.15;color:#0f172a;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .cell .qtyline{font-size:12px;font-weight:900;color:var(--muted);}
    .cell.empty .pname{color:var(--muted);font-weight:800}
    .cell.filled{background:linear-gradient(135deg,rgba(25,118,210,.08),rgba(100,181,246,.10));border-color:rgba(25,118,210,.25);}
    .cell.selected{outline:3px solid rgba(25,118,210,.35);border-color:rgba(25,118,210,.45);background:linear-gradient(135deg,rgba(25,118,210,.12),rgba(100,181,246,.12));}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;z-index:9999;}
    .modal{
      width:min(1100px,100%);background:#fff;border-radius:18px 18px 0 0;padding:14px;
      border:1px solid var(--border);box-shadow:0 -20px 50px rgba(0,0,0,.25);max-height:86vh;overflow:auto;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .modalHead h3{margin:0;font-size:15px;}
    .xbtn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;}

    /* Toast */
    #toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(15,23,42,.92);color:#fff;padding:10px 14px;border-radius:14px;font-weight:900;
      z-index:99999;box-shadow:0 12px 30px rgba(0,0,0,.22);opacity:0;pointer-events:none;transition:opacity .2s;
    }
    .hidden{display:none !important}

    .toggle{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);
      border-radius:14px;background:#fff;font-size:13px;color:#0f172a;font-weight:900;
    }
    .toggle input{width:auto}

    /* Stock panel */
    .stockPanel{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}
    .stockPanel button{padding:10px 12px;border-radius:14px;font-weight:900;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">VT</div>
      <div class="title">
        <h1>V·ªã tr√≠ s·∫£n ph·∫©m + T·ªìn kho</h1>
        <p>Upload t·ªìn kho (CSV/Excel) ‚Üí <b>t·ª± t·∫°o t·ªìn theo SKU</b> v√† hi·ªÉn th·ªã ngay (grid + list).</p>
      </div>
    </div>

    <div class="topRight">
      <div class="stockPanel">
        <button class="primary" id="uploadStockBtn">‚¨ÜÔ∏è Upload t·ªìn kho</button>
        <button class="ghost" id="clearStockBtn">üßπ B·ªè t·ªìn</button>
        <input id="stockFile" type="file" accept=".csv,.xlsx,.xls" class="hidden" />
      </div>
      <div class="pill" id="stockPill">T·ªìn: ch∆∞a c√≥ file</div>
      <div class="pill" id="statusPill">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="lookup">üîé Tra c·ª©u</div>
    <div class="tab" data-tab="layout">üß≠ S∆° ƒë·ªì k·ªá</div>
    <div class="tab" data-tab="products">üì¶ Danh s√°ch s·∫£n ph·∫©m</div>
    <div class="tab" data-tab="backup">üõü Sao l∆∞u</div>
  </div>

  <!-- LOOKUP -->
  <div id="tab-lookup" class="card">
    <h2>Tra c·ª©u v·ªã tr√≠ theo t√™n / SKU</h2>
    <p class="hint">G√µ t√™n ho·∫∑c SKU. T·ªìn hi·ªÉn th·ªã theo SKU (∆∞u ti√™n) ‚Üí n·∫øu kh√¥ng c√≥ SKU th√¨ fallback theo t√™n (n·∫øu b·∫°n ch·ªçn c·ªôt t√™n l√∫c build).</p>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m</label>
        <input id="lookupInput" placeholder="VD: m√¨ h·∫£o h·∫£o / 1053047..." autocomplete="off"/>
      </div>
      <div>
        <label>L·ªçc theo k·ªá (tu·ª≥ ch·ªçn)</label>
        <select id="lookupShelf">
          <option value="">T·∫•t c·∫£ k·ªá</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>
    <div id="lookupResult" class="list"></div>
    <p id="lookupEmpty" class="small">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>
  </div>

  <!-- LAYOUT -->
  <div id="tab-layout" class="hidden">
    <div class="row">
      <div class="card">
        <h2>T·∫°o / qu·∫£n l√Ω k·ªá</h2>

        <div class="grid2">
          <div>
            <label>T√™n k·ªá</label>
            <input id="newShelfName" placeholder="VD: K·ªá 30" />
          </div>
          <div>
            <label>S·ªë m√¢m trong k·ªá</label>
            <input id="newShelfTrays" inputmode="numeric" placeholder="VD: 5" value="5" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>S·ªë v·ªã tr√≠ m·ªói m√¢m (√¥ l∆∞·ªõi)</label>
            <input id="newShelfSlots" inputmode="numeric" placeholder="VD: 30" value="30" />
          </div>
          <div>
            <label>G·ª£i √Ω</label>
            <div class="pill warn">B·∫°n c√≥ th·ªÉ ƒë·ªïi s·ªë v·ªã tr√≠ sau (trong k·ªá ƒë√£ t·∫°o)</div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="createShelfBtn">‚ûï T·∫°o k·ªá</button>
          <button class="ghost" id="renameShelfBtn">‚úèÔ∏è ƒê·ªïi t√™n k·ªá</button>
          <button class="ghost" id="changeSlotsBtn">üî¢ ƒê·ªïi s·ªë v·ªã tr√≠/m√¢m</button>
          <button class="danger" id="deleteShelfBtn">üóëÔ∏è Xo√° k·ªá</button>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label>Ch·ªçn k·ªá</label>
            <select id="shelfSelect"></select>
          </div>
          <div>
            <label>Ch·ªçn m√¢m</label>
            <select id="traySelect"></select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="openAssignBtn">‚ö° G√°n nhanh (ch·∫°m SP = +1 v·ªã tr√≠)</button>
          <button class="ghost" id="trayRenameBtn">‚úèÔ∏è ƒê·ªïi t√™n m√¢m</button>
          <button class="danger" id="trayClearBtn">üßπ Xo√° to√†n b·ªô SP trong m√¢m</button>
        </div>

        <div class="divider"></div>

        <h2>Thi·∫øt l·∫≠p c·ªôt t·ªìn kho (n·∫øu auto ƒëo√°n sai)</h2>
        <p class="hint">Khi upload t·ªìn kho, h·ªá th·ªëng s·∫Ω t·ª± ƒëo√°n c·ªôt v√† <b>t·ª± build t·ªìn</b>. N·∫øu sai, b·∫°n ƒë·ªïi c·ªôt ·ªü ƒë√¢y r·ªìi b·∫•m ‚ÄúT·∫°o danh m·ª•c t·ªìn‚Äù.</p>

        <div class="grid2">
          <div>
            <label>C·ªôt SKU (M√£ SP)</label>
            <select id="stockColSku" disabled>
              <option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>
            </select>
          </div>
          <div>
            <label>C·ªôt t√™n SP (tu·ª≥ ch·ªçn)</label>
            <select id="stockColName" disabled>
              <option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>C·ªôt s·ªë t·ªìn</label>
            <select id="stockColQty" disabled>
              <option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>
            </select>
          </div>
          <div>
            <label>G·ª£i √Ω</label>
            <div class="pill warn">∆Øu ti√™n ƒë√∫ng: <b>M√£ s·∫£n ph·∫©m c∆° s·ªü</b> + <b>T·ªìn kho hi·ªán t·∫°i</b></div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="buildStockBtn" disabled>‚úÖ T·∫°o danh m·ª•c t·ªìn</button>
          <button class="ghost" id="refreshFromStockBtn" disabled>üîÑ C·∫≠p nh·∫≠t hi·ªÉn th·ªã</button>
        </div>

        <p class="small" id="stockInfo" style="margin-top:10px;"></p>
        <p class="small" id="layoutInfo" style="margin-top:10px;"></p>
      </div>

      <div class="card">
        <h2>M√¢m d·∫°ng l∆∞·ªõi v·ªã tr√≠</h2>
        <p class="hint">
          Ch·∫°m v√†o √¥ ƒë·ªÉ ch·ªçn v·ªã tr√≠. N·∫øu c√≥ t·ªìn kho, m·ªói √¥ s·∫Ω hi·ªán t·ªìn c·ªßa s·∫£n ph·∫©m (theo SKU).
        </p>

        <div class="gridWrap">
          <div class="gridHead">
            <div class="left" id="gridTags"></div>
            <div class="right">
              <span class="tag">ƒê√£ g√°n: <strong id="assignedCount">0</strong></span>
              <span class="tag">Tr·ªëng: <strong id="emptyCount">0</strong></span>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>T√¨m nhanh trong m√¢m (t√™n / SKU)</label>
              <input id="traySearch" placeholder="g√µ ƒë·ªÉ l·ªçc list b√™n d∆∞·ªõi..." autocomplete="off"/>
            </div>
            <div>
              <label>S·∫Øp x·∫øp list</label>
              <select id="traySort">
                <option value="posAsc">V·ªã tr√≠ ‚Üë</option>
                <option value="posDesc">V·ªã tr√≠ ‚Üì</option>
                <option value="nameAsc">T√™n A‚ÜíZ</option>
                <option value="nameDesc">T√™n Z‚ÜíA</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>
          <div id="trayGrid" class="grid"></div>
          <div class="divider"></div>

          <div class="grid2">
            <div><div class="pill" id="selectedInfo">Ch∆∞a ch·ªçn √¥</div></div>
            <div class="btns" style="justify-content:flex-end;margin-top:0">
              <button class="ghost" id="copySelectedBtn">üìã Copy</button>
              <button class="ghost" id="replaceSelectedBtn">üîÅ Thay SP</button>
              <button class="danger" id="clearSelectedBtn">üóëÔ∏è Xo√° √¥</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <h2>Danh s√°ch trong m√¢m (d·∫°ng list)</h2>
        <div id="trayList" class="list"></div>
        <p id="trayEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m trong m√¢m n√†y.</p>
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="tab-products" class="hidden">
    <div class="row">
      <div class="card">
        <h2>Nh·∫≠p danh s√°ch s·∫£n ph·∫©m (master)</h2>
        <p class="hint">
          ‚úÖ H·ªó tr·ª£ d√°n theo d√≤ng:
          <b>SKU, T√äN</b> ho·∫∑c <b>SKU[TAB]T√äN</b> ho·∫∑c ch·ªâ <b>T√äN</b>. <br/>
          (N·∫øu ch·ªâ d√°n t√™n th√¨ s·∫Ω <b>kh√¥ng kh·ªõp t·ªìn theo SKU</b>.)
        </p>
        <textarea id="productTextarea" placeholder="VD:
1053047000551, M√å H·∫¢O H·∫¢O T√îM CHUA CAY 75G
1053047000197	M√å SPAGHETTI ..."></textarea>
        <div class="btns">
          <button class="primary" id="addProductsBtn">‚úÖ Th√™m / c·∫≠p nh·∫≠t danh s√°ch</button>
          <button class="ghost" id="importCSVBtn">‚¨ÜÔ∏è Import CSV (T√™n + SKU)</button>
          <input id="csvFile" type="file" accept=".csv" class="hidden" />
          <button class="danger" id="clearProductsBtn">üóëÔ∏è Xo√° danh s√°ch SP</button>
        </div>
        <p class="small" id="productStats"></p>
      </div>

      <div class="card">
        <h2>Danh s√°ch s·∫£n ph·∫©m hi·ªán c√≥</h2>
        <div class="grid2">
          <div>
            <label>T√¨m trong master (t√™n / SKU)</label>
            <input id="masterSearch" placeholder="g√µ ƒë·ªÉ l·ªçc..." autocomplete="off"/>
          </div>
          <div>
            <label>Hi·ªÉn th·ªã</label>
            <select id="masterLimit">
              <option value="50">50 d√≤ng</option>
              <option value="150">150 d√≤ng</option>
              <option value="500">500 d√≤ng</option>
            </select>
          </div>
        </div>
        <div class="divider"></div>
        <div id="masterList" class="list"></div>
        <p id="masterEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m. H√£y nh·∫≠p danh s√°ch ·ªü b√™n tr√°i.</p>
      </div>
    </div>
  </div>

  <!-- BACKUP -->
  <div id="tab-backup" class="card hidden">
    <h2>Sao l∆∞u / kh√¥i ph·ª•c</h2>
    <p class="hint">D·ªØ li·ªáu l∆∞u trong m√°y (localStorage). B·∫°n n√™n export JSON ƒë·ªÉ backup.</p>
    <div class="btns">
      <button class="primary" id="exportBtn">‚¨áÔ∏è Export JSON</button>
      <button class="ghost" id="importBtn">‚¨ÜÔ∏è Import JSON</button>
      <input id="jsonFile" type="file" accept=".json" class="hidden" />
      <button class="danger" id="resetAllBtn">üß® Xo√° t·∫•t c·∫£ d·ªØ li·ªáu</button>
    </div>
    <div class="divider"></div>
    <p class="small mono" id="backupInfo"></p>
  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">G√°n nhanh</h3>
      <button class="xbtn" id="closeModal">‚úï</button>
    </div>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m (master) (t√™n / SKU)</label>
        <input id="modalSearch" placeholder="g√µ t√™n / SKU..." autocomplete="off"/>
      </div>
      <div>
        <label>V·ªã tr√≠ b·∫Øt ƒë·∫ßu</label>
        <input id="modalPos" inputmode="numeric" placeholder="VD: 1" />
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="toggle">
        <input type="checkbox" id="skipUsedToggle" checked />
        <span>Lu√¥n nh·∫£y t·ªõi <b>v·ªã tr√≠ tr·ªëng</b> (t·ª± b·ªè qua √¥ ƒë√£ c√≥)</span>
      </div>
      <div class="toggle">
        <input type="checkbox" id="autoCloseToggle" />
        <span>T·ª± ƒë√≥ng khi g√°n xong (tu·ª≥ b·∫°n)</span>
      </div>
    </div>

    <p class="hint" style="margin-top:10px">
      ‚úÖ Ch·∫ø ƒë·ªô g√°n nhanh: <b>ch·∫°m s·∫£n ph·∫©m</b> ‚Üí g√°n v√†o v·ªã tr√≠ hi·ªán t·∫°i ‚Üí t·ª± tƒÉng l√™n v·ªã tr√≠ ti·∫øp theo.
    </p>

    <div class="divider"></div>
    <div id="modalPickList" class="list"></div>
    <p id="modalEmpty" class="small">G√µ ƒë·ªÉ t√¨m s·∫£n ph·∫©m r·ªìi ch·∫°m ƒë·ªÉ g√°n.</p>

    <div class="divider"></div>
    <div class="btns">
      <button class="ghost" id="undoAssignBtn">‚Ü©Ô∏è Ho√†n t√°c 1 b∆∞·ªõc</button>
      <button class="primary" id="finishAssignBtn">‚úÖ Xong</button>
    </div>
    <p class="small" id="modalNote" style="margin-top:10px;"></p>
  </div>
</div>

<div id="toast">OK</div>

<script>
/* =========================
   Helpers
========================= */
const LS_KEY = "vitri_sanpham_v5_auto_stock_by_sku";

function removeAccents(str){
  return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}
function norm(str){
  const s = String(str ?? "").trim().replace(/\s+/g," ");
  return removeAccents(s).toUpperCase();
}
function normSku(v){
  if(v === null || v === undefined) return "";
  if(typeof v === "number"){
    // Excel hay ƒë·ªçc m√£ th√†nh s·ªë -> √©p v·ªÅ integer string
    return String(Math.trunc(v)).trim();
  }
  return String(v).trim();
}
function uid(prefix="ID"){ return prefix + "_" + Math.random().toString(36).slice(2,10).toUpperCase(); }
function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
function toInt(v){ const n = parseInt(String(v ?? "").trim(), 10); return Number.isFinite(n) ? n : null; }
function toNumber(v){
  if(v === null || v === undefined) return NaN;
  const s0 = String(v).trim();
  if(!s0) return NaN;
  const s = s0.replace(/\s+/g,"");
  const vn = /^\d{1,3}(\.\d{3})+$/.test(s) ? s.replace(/\./g,'') : s;
  const clean = vn.replace(/,/g,'');
  const n = Number(clean);
  return Number.isFinite(n) ? n : NaN;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function qtyClass(q){
  if(q === null || !Number.isFinite(q)) return "";
  if(q <= 0) return "bad";
  if(q < 5) return "warn";
  return "ok";
}
function fmtQty(q){
  if(q === null || q === undefined || !Number.isFinite(q)) return "‚Äî";
  return String(q);
}

/* =========================
   Stock file parsers
========================= */
function parseCSV(text){
  const rawLines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
  if(rawLines.length===0) return {headers:[], rows:[]};

  const headerLine = rawLines[0];
  const commaCount = (headerLine.match(/,/g) || []).length;
  const semiCount  = (headerLine.match(/;/g) || []).length;
  const SEP = semiCount > commaCount ? ";" : ",";

  const parseLine = (line)=>{
    const out=[];
    let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === SEP && !inQ){
        out.push(cur); cur='';
      } else cur += ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };

  const h = parseLine(rawLines[0]);
  const rs = [];
  for(let i=1;i<rawLines.length;i++){
    const cols = parseLine(rawLines[i]);
    const obj = {};
    for(let j=0;j<h.length;j++) obj[h[j]] = cols[j] ?? '';
    rs.push(obj);
  }
  return {headers:h, rows:rs};
}

function parseExcel(arrayBuffer){
  const wb = XLSX.read(arrayBuffer, {type:'array'});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(ws, {defval:''});
  const hs = json.length ? Object.keys(json[0]) : [];
  return {headers:hs, rows:json};
}

/* =========================
   State
========================= */
let state = {
  products: [], // [{id,name,key,sku}]
  shelves: [],
  locIndex: {},
  stock: {
    skuIndex: {},  // sku -> qty
    nameIndex: {}, // nameKey -> qty (fallback n·∫øu ch·ªçn c·ªôt t√™n)
    fileName: "",
    updatedAt: "",
    colSku: "",
    colName: "",
    colQty: "",
    rowsCount: 0,
    keysCount: 0,
    match: { totalMaster:0, masterWithSku:0, matchedSku:0 }
  }
};

let productMap = new Map();
function rebuildProductMap(){ productMap = new Map((state.products||[]).map(p=>[p.key,p])); }
function productByKey(key){ return productMap.get(key) || null; }
function productNameByKey(key){ return productByKey(key)?.name ?? key; }

/* ‚úÖ l·∫•y t·ªìn: ∆∞u ti√™n SKU -> fallback theo t√™n (n·∫øu c√≥) */
function getStockQtyForProductKey(productKey){
  const p = productByKey(productKey);
  const sku = normSku(p?.sku);
  const skuIdx = state.stock.skuIndex || {};
  if(sku){
    if(sku in skuIdx) return skuIdx[sku];
    // n·∫øu SKU c√≥ nhi·ªÅu m√£ ph√¢n c√°ch , ; th√¨ th·ª≠ t·ª´ng m√£
    if(sku.includes(",") || sku.includes(";")){
      const parts = sku.split(/[;,]/).map(s=>normSku(s)).filter(Boolean);
      for(const s of parts) if(s in skuIdx) return skuIdx[s];
    }
  }
  const nameIdx = state.stock.nameIndex || {};
  if(productKey in nameIdx) return nameIdx[productKey];
  return null;
}

/* =========================
   Persistence
========================= */
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}

  state.products ??= [];
  state.shelves ??= [];
  state.locIndex ??= {};
  state.stock ??= {skuIndex:{}, nameIndex:{}, fileName:"", updatedAt:"", colSku:"", colName:"", colQty:"", rowsCount:0, keysCount:0, match:{totalMaster:0, masterWithSku:0, matchedSku:0}};
  state.stock.skuIndex ??= {};
  state.stock.nameIndex ??= {};
  state.stock.match ??= {totalMaster:0, masterWithSku:0, matchedSku:0};

  state.products = (state.products||[]).map(p=>({
    id: p.id || uid("SP"),
    name: p.name ?? "",
    key: p.key ?? norm(p.name ?? ""),
    sku: p.sku ?? ""
  }));

  rebuildProductMap();
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  refreshStatus();
}

/* =========================
   UI helpers
========================= */
const $ = (id)=>document.getElementById(id);
const statusPill = $("statusPill");
const stockPill  = $("stockPill");

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.opacity="0", 1100);
}

function setStockInfo(text, type=""){
  const el = $("stockInfo");
  el.innerHTML = text;
  el.className = "small " + (type ? type : "");
}

function refreshStatus(){
  const p = state.products.length;
  const s = state.shelves.length;
  const a = Object.keys(state.locIndex || {}).length;

  statusPill.className = "pill " + (a ? "ok" : (p || s ? "warn" : ""));
  statusPill.textContent = `SP: ${p} ‚Ä¢ K·ªá: ${s} ‚Ä¢ ƒê√£ g√°n: ${a}`;

  const stockKeys = Object.keys(state.stock.skuIndex || {}).length;
  if(stockKeys){
    stockPill.className = "pill ok";
    const time = state.stock.updatedAt ? new Date(state.stock.updatedAt).toLocaleString() : "";
    const m = state.stock.match || {totalMaster:0, masterWithSku:0, matchedSku:0};
    stockPill.textContent = `T·ªìn(SKU): ${stockKeys} ‚Ä¢ Kh·ªõp: ${m.matchedSku}/${m.masterWithSku} ‚Ä¢ ${state.stock.fileName || "file"}${time ? " ‚Ä¢ " + time : ""}`;
  }else{
    stockPill.className = "pill";
    stockPill.textContent = "T·ªìn: ch∆∞a c√≥ file";
  }

  $("backupInfo").textContent =
    `products=${p}, shelves=${s}, assigned=${a}, stockSkuKeys=${stockKeys}, key=${LS_KEY}`;

  const hasRaw = (window._stockHeaders?.length || 0) && (window._stockRawRows?.length || 0);
  $("buildStockBtn").disabled = !hasRaw;
  $("refreshFromStockBtn").disabled = !(stockKeys>0);

  const selDisabled = !(window._stockHeaders?.length);
  $("stockColSku").disabled = selDisabled;
  $("stockColName").disabled = selDisabled;
  $("stockColQty").disabled = selDisabled;
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const key = tab.dataset.tab;
    ["lookup","layout","products","backup"].forEach(k=>{
      const el = $("tab-"+k);
      if(k===key) el.classList.remove("hidden");
      else el.classList.add("hidden");
    });
    renderAll();
  });
});

/* =========================
   Stock upload + auto build
========================= */
window._stockRawRows = [];
window._stockHeaders = [];

function fillStockSelects(headers){
  window._stockHeaders = headers.slice();

  const colSku  = $("stockColSku");
  const colName = $("stockColName");
  const colQty  = $("stockColQty");

  const fill = (sel)=>{
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "(Ch·ªçn c·ªôt)";
    sel.appendChild(opt0);
    headers.forEach(h=>{
      const op = document.createElement("option");
      op.value = h; op.textContent = h;
      sel.appendChild(op);
    });
  };
  fill(colSku); fill(colName); fill(colQty);

  // auto guess
  const normH = headers.map(h=>({h, t: removeAccents(String(h)).toLowerCase()}));

  const pickSku =
    normH.find(x => x.t.includes("ma san pham co so")) ||
    normH.find(x => x.t.includes("sku")) ||
    normH.find(x => x.t.includes("ma san pham") || x.t.includes("masp")) ||
    normH.find(x => x.t.includes("barcode") || x.t.includes("ean") || x.t.includes("upc") || x.t.includes("code"));

  const pickQty =
    normH.find(x => x.t.includes("ton kho hien tai")) ||
    normH.find(x => x.t.includes("ton") || x.t.includes("qty") || x.t.includes("stock") || x.t.includes("so luong") || x.t === "sl");

  const pickName =
    normH.find(x => (x.t.includes("ten") && (x.t.includes("sp") || x.t.includes("san") || x.t.includes("product") || x.t.includes("name") || x.t.includes("hang")))) ||
    normH.find(x => x.t.includes("model")) ||
    normH.find(x => x.t.includes("ten") || x.t.includes("name") || x.t.includes("product"));

  // ∆∞u ti√™n gi√° tr·ªã l∆∞u tr∆∞·ªõc
  if(state.stock.colSku && headers.includes(state.stock.colSku)) colSku.value = state.stock.colSku;
  else if(pickSku) colSku.value = pickSku.h;

  if(state.stock.colQty && headers.includes(state.stock.colQty)) colQty.value = state.stock.colQty;
  else if(pickQty) colQty.value = pickQty.h;

  if(state.stock.colName && headers.includes(state.stock.colName)) colName.value = state.stock.colName;
  else if(pickName) colName.value = pickName.h;

  setStockInfo(`ƒê√£ n·∫°p d·ªØ li·ªáu t·ªìn: <b>${headers.length}</b> c·ªôt ‚Ä¢ <b>${window._stockRawRows.length}</b> d√≤ng. ƒêang t·ª± t·∫°o t·ªìn theo SKU...`, "warn");
  refreshStatus();
}

function calcMatchStats(){
  const skuIdx = state.stock.skuIndex || {};
  const master = state.products || [];
  let totalMaster = master.length;
  let masterWithSku = 0;
  let matchedSku = 0;

  for(const p of master){
    const sku = normSku(p.sku);
    if(!sku) continue;
    masterWithSku++;
    if(sku in skuIdx) matchedSku++;
    else if(sku.includes(",") || sku.includes(";")){
      const parts = sku.split(/[;,]/).map(s=>normSku(s)).filter(Boolean);
      if(parts.some(x=> x in skuIdx)) matchedSku++;
    }
  }
  state.stock.match = { totalMaster, masterWithSku, matchedSku };
}

function buildStockIndexFromCurrentSelects(){
  const skuCol  = $("stockColSku").value;
  const nameCol = $("stockColName").value;
  const qtyCol  = $("stockColQty").value;

  if(!skuCol || !qtyCol){
    setStockInfo("‚ö†Ô∏è Thi·∫øu c·ªôt SKU ho·∫∑c c·ªôt T·ªìn. V√†o tab S∆° ƒë·ªì k·ªá ‚Üí ch·ªçn ƒë√∫ng c·ªôt r·ªìi b·∫•m ‚ÄúT·∫°o danh m·ª•c t·ªìn‚Äù.", "bad");
    return false;
  }

  const skuMap = {};
  const nameMap = {};
  let used=0, skipped=0;

  for(const r of window._stockRawRows){
    const sku = normSku(r[skuCol]);
    if(!sku){ skipped++; continue; }

    const qty = toNumber(r[qtyCol]);
    if(!Number.isFinite(qty)){ skipped++; continue; }

    skuMap[sku] = (skuMap[sku] ?? 0) + qty;

    if(nameCol){
      const k = norm(r[nameCol]);
      if(k) nameMap[k] = (nameMap[k] ?? 0) + qty;
    }
    used++;
  }

  state.stock.skuIndex = skuMap;
  state.stock.nameIndex = nameMap;
  state.stock.colSku  = skuCol;
  state.stock.colName = nameCol || "";
  state.stock.colQty  = qtyCol;
  state.stock.rowsCount = window._stockRawRows.length;
  state.stock.keysCount = Object.keys(skuMap).length;
  state.stock.updatedAt = new Date().toISOString();

  calcMatchStats();
  save();

  const m = state.stock.match;
  const type = m.masterWithSku === 0 ? "warn" : (m.matchedSku > 0 ? "ok" : "bad");

  setStockInfo(
    `‚úÖ ƒê√£ t·∫°o t·ªìn theo SKU: <b>${state.stock.keysCount}</b> m√£ (ƒë·ªçc ${used} d√≤ng, b·ªè ${skipped} d√≤ng).<br/>
     üìå Kh·ªõp master theo SKU: <b>${m.matchedSku}</b>/<b>${m.masterWithSku}</b> (t·ªïng master: ${m.totalMaster}).`,
    type
  );

  renderAll();
  toast("ƒê√£ t·∫°o t·ªìn (SKU)");
  return true;
}

$("buildStockBtn").addEventListener("click", ()=>{
  const ok = buildStockIndexFromCurrentSelects();
  if(!ok) toast("Ch∆∞a t·∫°o ƒë∆∞·ª£c t·ªìn (thi·∫øu c·ªôt)");
});
$("refreshFromStockBtn").addEventListener("click", ()=>{ toast("ƒê√£ c·∫≠p nh·∫≠t hi·ªÉn th·ªã"); renderAll(); });

$("uploadStockBtn").addEventListener("click", ()=> $("stockFile").click());

$("stockFile").addEventListener("change", async ()=>{
  const f = $("stockFile").files?.[0];
  if(!f) return;

  try{
    const ext = (f.name.split(".").pop() || "").toLowerCase();
    setStockInfo("ƒêang ƒë·ªçc file t·ªìn...", "warn");

    if(ext === "csv"){
      const text = await f.text();
      const parsed = parseCSV(text);
      window._stockRawRows = parsed.rows;
      fillStockSelects(parsed.headers);
    }else if(ext === "xlsx" || ext === "xls"){
      const ok = await ensureXLSX();
      if(!ok){
        setStockInfo("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán ƒë·ªçc Excel (XLSX). Th·ª≠ ƒë·ªïi m·∫°ng ho·∫∑c t·∫£i l·∫°i trang.", "bad");
        return;
      }
      const buf = await f.arrayBuffer();
      const parsed = parseExcel(buf);
      window._stockRawRows = parsed.rows;
      fillStockSelects(parsed.headers);
    }else{
      setStockInfo("‚ùå ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£. Ch·ªâ nh·∫≠n CSV/XLSX/XLS.", "bad");
      window._stockRawRows = [];
      window._stockHeaders = [];
      refreshStatus();
      return;
    }

    state.stock.fileName = f.name;
    save();
    toast("ƒê√£ n·∫°p file t·ªìn");

    // ‚úÖ AUTO BUILD NGAY SAU UPLOAD
    const built = buildStockIndexFromCurrentSelects();
    if(!built){
      setStockInfo("‚ö†Ô∏è Upload xong nh∆∞ng ch∆∞a build ƒë∆∞·ª£c t·ªìn (thi·∫øu c·ªôt). V√†o tab S∆° ƒë·ªì k·ªá ƒë·ªÉ ch·ªçn c·ªôt ƒë√∫ng.", "bad");
    }
  }catch(e){
    console.error(e);
    setStockInfo(`‚ùå L·ªói ƒë·ªçc file t·ªìn: <b>${escapeHtml(e?.message || String(e))}</b>`, "bad");
  }finally{
    $("stockFile").value = "";
  }
});

$("clearStockBtn").addEventListener("click", ()=>{
  window._stockRawRows = [];
  window._stockHeaders = [];

  state.stock = {
    skuIndex:{}, nameIndex:{},
    fileName:"", updatedAt:"",
    colSku:"", colName:"", colQty:"",
    rowsCount:0, keysCount:0,
    match:{totalMaster:0, masterWithSku:0, matchedSku:0}
  };
  save();

  $("stockColSku").innerHTML  = `<option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>`;
  $("stockColName").innerHTML = `<option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>`;
  $("stockColQty").innerHTML  = `<option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>`;
  $("stockColSku").disabled = true;
  $("stockColName").disabled = true;
  $("stockColQty").disabled  = true;

  setStockInfo("ƒê√£ b·ªè t·ªìn kho.", "warn");
  renderAll();
  toast("ƒê√£ b·ªè t·ªìn");
});

/* =========================
   Products (master)
========================= */
function parseLineToProduct(line){
  const raw = String(line ?? "").trim();
  if(!raw) return null;

  // ∆∞u ti√™n: SKU,NAME ho·∫∑c SKU\tNAME
  const tab = raw.split("\t");
  if(tab.length >= 2){
    const sku = tab[0].trim();
    const name = tab.slice(1).join(" ").trim();
    if(name) return {sku, name};
  }

  const comma = raw.split(",");
  if(comma.length >= 2){
    const left = comma[0].trim();
    const right = comma.slice(1).join(",").trim();
    // n·∫øu v·∫ø tr√°i nh√¨n gi·ªëng sku (nhi·ªÅu s·ªë) -> coi l√† SKU
    if(/^\d{6,}$/.test(left) && right) return {sku:left, name:right};
  }

  // d·∫°ng "SKU - NAME"
  const dash = raw.split(" - ");
  if(dash.length >= 2 && /^\d{6,}$/.test(dash[0].trim())){
    return {sku:dash[0].trim(), name:dash.slice(1).join(" - ").trim()};
  }

  // fallback: ch·ªâ c√≥ t√™n
  return {sku:"", name:raw};
}

function mergeProductsFromLines(lines){
  const set = new Map(state.products.map(p=>[p.key, p]));
  let added=0, updatedSku=0;

  for(const line of lines){
    const parsed = parseLineToProduct(line);
    if(!parsed) continue;

    const name = String(parsed.name ?? "").trim();
    const sku  = String(parsed.sku ?? "").trim();
    if(!name) continue;

    const key = norm(name);
    if(!key) continue;

    if(!set.has(key)){
      set.set(key, {id: uid("SP"), name, key, sku});
      added++;
    }else{
      const obj = set.get(key);
      if(sku && !obj.sku){ obj.sku = sku; updatedSku++; }
    }
  }

  state.products = Array.from(set.values()).sort((a,b)=>a.name.localeCompare(b.name,"vi"));
  rebuildProductMap();
  calcMatchStats();
  save();
  toast(`ƒê√£ c·∫≠p nh·∫≠t (+${added}) ‚Ä¢ SKU c·∫≠p nh·∫≠t: ${updatedSku}`);
}

function parseCSVToProducts(text){
  const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  if(!lines.length) return [];

  const parseLine = (line)=>{
    const out=[]; let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch === "," && !inQ){
        out.push(cur); cur="";
      }else cur += ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };

  const header = parseLine(lines[0]).map(h=>removeAccents(h).toLowerCase());
  const findCol = (preds)=>{
    for(const p of preds){
      const idx = header.findIndex(h => h.includes(p));
      if(idx >= 0) return idx;
    }
    return -1;
  };

  const nameIdx = findCol(["ten","name","product","model"]);
  const skuIdx  = findCol(["ma san pham co so","sku","ma sp","masp","code","barcode","ean","upc"]);

  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols = parseLine(lines[i]);
    const name = (nameIdx>=0 ? cols[nameIdx] : cols[0]) ?? "";
    const sku  = (skuIdx>=0 ? cols[skuIdx] : "") ?? "";
    if(String(name).trim()) out.push({name:String(name).trim(), sku:String(sku||"").trim()});
  }
  return out;
}

$("addProductsBtn").addEventListener("click", ()=>{
  const lines = $("productTextarea").value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(!lines.length){ toast("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ th√™m"); return; }
  mergeProductsFromLines(lines);
  $("productTextarea").value = "";
  renderProducts(); renderLookup();
});

$("clearProductsBtn").addEventListener("click", ()=>{
  if(!state.products.length){ toast("Danh s√°ch SP ƒëang tr·ªëng"); return; }
  if(confirm("Xo√° to√†n b·ªô danh s√°ch s·∫£n ph·∫©m (master)?")){
    state.products = [];
    rebuildProductMap();
    calcMatchStats();
    save();
    renderProducts(); renderLookup();
    toast("ƒê√£ xo√° danh s√°ch SP");
  }
});

$("importCSVBtn").addEventListener("click", ()=> $("csvFile").click());
$("csvFile").addEventListener("change", async ()=>{
  const f = $("csvFile").files?.[0];
  if(!f) return;
  const text = await f.text();
  const arr = parseCSVToProducts(text);

  // merge by key (name key), update sku if empty
  const set = new Map(state.products.map(p=>[p.key,p]));
  let added=0, updated=0;

  for(const x of arr){
    const name = String(x.name||"").trim();
    const sku  = String(x.sku||"").trim();
    if(!name) continue;
    const key = norm(name);
    if(!key) continue;

    if(!set.has(key)){
      set.set(key, {id:uid("SP"), name, key, sku});
      added++;
    }else{
      const p = set.get(key);
      if(sku && !p.sku){ p.sku = sku; updated++; }
    }
  }

  state.products = Array.from(set.values()).sort((a,b)=>a.name.localeCompare(b.name,"vi"));
  rebuildProductMap();
  calcMatchStats();
  save();

  $("csvFile").value = "";
  renderProducts(); renderLookup();
  toast(`Import xong (+${added}) ‚Ä¢ SKU c·∫≠p nh·∫≠t: ${updated}`);
});

/* =========================
   Render master list
========================= */
function renderProducts(){
  const q = norm($("masterSearch").value);
  const limit = parseInt($("masterLimit").value,10) || 50;

  let arr = state.products;
  if(q){
    arr = arr.filter(p=> p.key.includes(q) || normSku(p.sku).includes(q));
  }

  const m = state.stock.match || {totalMaster:0, masterWithSku:0, matchedSku:0};
  $("productStats").textContent =
    `T·ªïng: ${state.products.length} ‚Ä¢ C√≥ SKU: ${m.masterWithSku} ‚Ä¢ Kh·ªõp t·ªìn: ${m.matchedSku} ‚Ä¢ Hi·ªÉn th·ªã: ${Math.min(arr.length, limit)}`;

  const list = $("masterList");
  list.innerHTML = "";
  $("masterEmpty").style.display = state.products.length ? "none" : "block";

  arr.slice(0, limit).forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const qv = getStockQtyForProductKey(p.key);
    const qcls = qtyClass(qv);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta">SKU: <b class="mono">${escapeHtml(p.sku || "‚Äî")}</b></div>
          <div class="meta">T·ªìn: <b class="${qcls}">${escapeHtml(fmtQty(qv))}</b></div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
        </div>
      </div>
    `;
    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî SKU: ${p.sku || "‚Äî"} ‚Äî ${locText} ‚Äî T·ªìn: ${fmtQty(qv)}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }catch(e){ alert(line); }
    });
    list.appendChild(item);
  });
}
$("masterSearch").addEventListener("input", debounce(renderProducts, 200));
$("masterLimit").addEventListener("change", renderProducts);

/* =========================
   Shelves / trays / slots
========================= */
function ensureShelfSelect(){
  const sel = $("shelfSelect");
  sel.innerHTML = "";
  if(!state.shelves.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ k·ªá";
    sel.appendChild(op);
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  if(!sel.value) sel.value = state.shelves[0].id;
}

function ensureTraySelect(){
  const shelfId = $("shelfSelect").value;
  const traySel = $("traySelect");
  traySel.innerHTML = "";
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf || !shelf.trays?.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ m√¢m";
    traySel.appendChild(op);
    traySel.disabled = true;
    return;
  }
  traySel.disabled = false;
  shelf.trays.forEach(t=>{
    const op = document.createElement("option");
    op.value = t.id;
    op.textContent = t.name;
    traySel.appendChild(op);
  });
  if(!traySel.value) traySel.value = shelf.trays[0].id;
}

function createShelf(name, trayCount, slotsPerTray){
  const n = String(name ?? "").trim();
  if(!n){ toast("Nh·∫≠p t√™n k·ªá"); return; }
  const count = Math.max(1, toInt(trayCount) ?? 5);
  const slots = Math.max(1, toInt(slotsPerTray) ?? 30);

  const trays = Array.from({length: count}, (_,i)=>({ id: uid("MAM"), name:`M√¢m ${i+1}`, slots:[] }));

  state.shelves.push({ id: uid("KE"), name:n, positionsPerTray: slots, trays });
  save(); toast("ƒê√£ t·∫°o k·ªá");
}

$("createShelfBtn").addEventListener("click", ()=>{
  createShelf($("newShelfName").value, $("newShelfTrays").value, $("newShelfSlots").value);
  $("newShelfName").value = "";
  renderLayout(); renderLookup();
});

$("renameShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }
  const n = prompt("ƒê·ªïi t√™n k·ªá:", shelf.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  shelf.name = nn; save();
  renderLayout(); renderLookup(); toast("ƒê√£ ƒë·ªïi t√™n k·ªá");
});

$("changeSlotsBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }
  const n = prompt("S·ªë v·ªã tr√≠ m·ªói m√¢m (√¥ l∆∞·ªõi):", String(shelf.positionsPerTray ?? 30));
  if(n===null) return;
  const slots = toInt(n);
  if(slots===null || slots<=0){ toast("S·ªë kh√¥ng h·ª£p l·ªá"); return; }
  shelf.positionsPerTray = slots;
  save(); renderTrayGrid(); toast("ƒê√£ ƒë·ªïi s·ªë v·ªã tr√≠/m√¢m");
});

$("deleteShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }

  const assignedInShelf = Object.keys(state.locIndex).filter(k=>state.locIndex[k].shelfId===shelfId).length;
  const msg = assignedInShelf
    ? `K·ªá n√†y ƒëang c√≥ ${assignedInShelf} SP ƒë√£ g√°n. Xo√° k·ªá s·∫Ω xo√° lu√¥n c√°c v·ªã tr√≠ ƒë√≥. Ti·∫øp t·ª•c?`
    : "Xo√° k·ªá n√†y?";
  if(!confirm(msg)) return;

  Object.keys(state.locIndex).forEach(k=>{
    if(state.locIndex[k].shelfId===shelfId) delete state.locIndex[k];
  });
  state.shelves = state.shelves.filter(s=>s.id!==shelfId);
  save(); renderLayout(); renderLookup(); toast("ƒê√£ xo√° k·ªá");
});

$("shelfSelect").addEventListener("change", ()=>{
  ensureTraySelect();
  selectedPos = null;
  renderTrayGrid(); renderTrayList(); renderLookupShelves();
});
$("traySelect").addEventListener("change", ()=>{
  selectedPos = null;
  renderTrayGrid(); renderTrayList();
});

$("trayRenameBtn").addEventListener("click", ()=>{
  const tray = getSelectedTray();
  if(!tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }
  const n = prompt("ƒê·ªïi t√™n m√¢m:", tray.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  tray.name = nn; save();
  renderLayout(); renderLookup(); toast("ƒê√£ ƒë·ªïi t√™n m√¢m");
});

$("trayClearBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }
  const count = tray.slots.length;
  if(!count){ toast("M√¢m ƒëang tr·ªëng"); return; }
  if(!confirm(`Xo√° to√†n b·ªô ${count} SP trong ${shelf.name} - ${tray.name}?`)) return;

  tray.slots.forEach(sl=>{ if(state.locIndex[sl.productKey]) delete state.locIndex[sl.productKey]; });
  tray.slots = [];
  selectedPos = null;
  save(); renderTrayGrid(); renderTrayList(); renderLookup(); toast("ƒê√£ xo√° SP trong m√¢m");
});

function getSelectedShelf(){ return state.shelves.find(s=>s.id===$("shelfSelect").value); }
function getSelectedTray(){
  const shelf = getSelectedShelf(); if(!shelf) return null;
  return shelf.trays.find(t=>t.id===$("traySelect").value);
}
function formatLoc(loc){
  const shelf = state.shelves.find(s=>s.id===loc.shelfId);
  const tray = shelf?.trays?.find(t=>t.id===loc.trayId);
  return `${shelf?.name ?? "(k·ªá ƒë√£ xo√°)"} ‚Ä¢ ${tray?.name ?? "(m√¢m ƒë√£ xo√°)"} ‚Ä¢ V·ªã tr√≠ ${loc.pos}`;
}

/* =========================
   Tray Grid + List + Modal
========================= */
let selectedPos = null;

function getNextFreePos(tray, startPos){
  const used = new Set((tray.slots||[]).map(s=>s.pos));
  let p = Math.max(1, startPos || 1);
  while(used.has(p)) p++;
  return p;
}
function slotAtPos(tray, pos){ return (tray.slots||[]).find(s=>s.pos===pos) || null; }

function removeProductFromOldLocation(productKey){
  const oldLoc = state.locIndex[productKey];
  if(!oldLoc) return null;
  const oldShelf = state.shelves.find(s=>s.id===oldLoc.shelfId);
  const oldTray  = oldShelf?.trays?.find(t=>t.id===oldLoc.trayId);
  if(oldTray) oldTray.slots = oldTray.slots.filter(sl=>sl.productKey!==productKey);
  return oldLoc;
}

function clearPosInCurrentTray(pos){
  const tray = getSelectedTray(); if(!tray) return;
  const sl = slotAtPos(tray, pos);
  if(!sl){ toast("√î ƒëang tr·ªëng"); return; }
  if(!confirm(`Xo√° "${productNameByKey(sl.productKey)}" kh·ªèi v·ªã tr√≠ ${pos}?`)) return;
  tray.slots = tray.slots.filter(s=>s.pos!==pos);
  delete state.locIndex[sl.productKey];
  save(); renderTrayGrid(); renderTrayList(); renderLookup(); toast("ƒê√£ xo√° √¥");
}

function renderTrayGrid(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  const grid = $("trayGrid");
  grid.innerHTML = "";

  if(!shelf || !tray){
    $("gridTags").innerHTML = "";
    $("assignedCount").textContent = "0";
    $("emptyCount").textContent = "0";
    $("selectedInfo").textContent = "Ch∆∞a ch·ªçn √¥";
    return;
  }

  const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
  const used = new Map(tray.slots.map(s=>[s.pos, s.productKey]));
  $("assignedCount").textContent = String(used.size);
  $("emptyCount").textContent = String(Math.max(0, maxPos - used.size));

  $("gridTags").innerHTML = `
    <span class="tag"><strong>${escapeHtml(shelf.name)}</strong></span>
    <span class="tag"><strong>${escapeHtml(tray.name)}</strong></span>
    <span class="tag">√î: <strong>${maxPos}</strong></span>
  `;

  for(let pos=1; pos<=maxPos; pos++){
    const key = used.get(pos);
    const cell = document.createElement("div");
    const isFilled = !!key;
    cell.className = "cell " + (isFilled ? "filled" : "empty") + (selectedPos===pos ? " selected" : "");

    let badgeHtml = `<span class="badge">T·ªìn: ‚Äî</span>`;
    let qtyLine = "";

    if(isFilled){
      const qv = getStockQtyForProductKey(key);
      const cls = qtyClass(qv);
      badgeHtml = `<span class="badge ${cls}">T·ªìn: ${escapeHtml(fmtQty(qv))}</span>`;
      qtyLine = `<div class="qtyline">T·ªìn: ${escapeHtml(fmtQty(qv))}</div>`;
    }

    cell.innerHTML = `
      <div class="pos"><span>#${pos}</span>${badgeHtml}</div>
      <div class="pname">${isFilled ? escapeHtml(productNameByKey(key)) : "Tr·ªëng"}</div>
      ${isFilled ? qtyLine : `<div class="qtyline">&nbsp;</div>`}
    `;
    cell.addEventListener("click", ()=>{
      selectedPos = pos;
      updateSelectedInfo();
      renderTrayGrid();
    });
    grid.appendChild(cell);
  }

  if(selectedPos === null || selectedPos < 1 || selectedPos > maxPos) selectedPos = null;
  updateSelectedInfo();
}

function updateSelectedInfo(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray || selectedPos === null){
    $("selectedInfo").className = "pill";
    $("selectedInfo").textContent = "Ch∆∞a ch·ªçn √¥";
    return;
  }
  const sl = slotAtPos(tray, selectedPos);
  if(!sl){
    $("selectedInfo").className = "pill warn";
    $("selectedInfo").textContent = `ƒêang ch·ªçn: V·ªã tr√≠ ${selectedPos} (TR·ªêNG)`;
  }else{
    const p = productByKey(sl.productKey);
    const qv = getStockQtyForProductKey(sl.productKey);
    $("selectedInfo").className = "pill ok";
    $("selectedInfo").textContent =
      `ƒêang ch·ªçn: V·ªã tr√≠ ${selectedPos} ‚Ä¢ ${productNameByKey(sl.productKey)} ‚Ä¢ SKU: ${p?.sku || "‚Äî"} ‚Ä¢ T·ªìn: ${fmtQty(qv)}`;
  }
}

$("clearSelectedBtn").addEventListener("click", ()=>{
  if(selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  clearPosInCurrentTray(selectedPos);
});

$("copySelectedBtn").addEventListener("click", async ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray || selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  const sl = slotAtPos(tray, selectedPos);
  const p = sl ? productByKey(sl.productKey) : null;
  const qv = sl ? getStockQtyForProductKey(sl.productKey) : null;

  const text = sl
    ? `${productNameByKey(sl.productKey)} ‚Äî SKU: ${p?.sku || "‚Äî"} ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${selectedPos} ‚Äî T·ªìn: ${fmtQty(qv)}`
    : `√î tr·ªëng ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${selectedPos}`;
  try{ await navigator.clipboard.writeText(text); toast("ƒê√£ copy"); }catch(e){ alert(text); }
});

$("replaceSelectedBtn").addEventListener("click", ()=>{
  if(selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  openAssignModal({ startPos: selectedPos });
});

/* Modal assign */
let modalAssignPos = 1;
let modalAssignedCount = 0;
let modalHistory = [];

function openAssignModal(opts = {}){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("C·∫ßn ch·ªçn k·ªá v√† m√¢m tr∆∞·ªõc"); return; }

  modalHistory = [];
  modalAssignedCount = 0;

  $("modalTitle").textContent = `G√°n nhanh: ${shelf.name} ‚Üí ${tray.name}`;
  $("modalSearch").value = "";
  $("modalPickList").innerHTML = "";
  $("modalEmpty").style.display = "block";

  const basePos = (typeof opts.startPos === "number" && opts.startPos > 0) ? opts.startPos : (selectedPos ?? 1);
  modalAssignPos = $("skipUsedToggle").checked ? getNextFreePos(tray, basePos) : Math.max(1, basePos);
  $("modalPos").value = String(modalAssignPos);

  $("modalNote").innerHTML = `V·ªã tr√≠ b·∫Øt ƒë·∫ßu: <b>${modalAssignPos}</b> ‚Ä¢ Ch·∫°m SP ƒë·ªÉ g√°n.`;
  $("modalBack").style.display = "flex";
  setTimeout(()=> $("modalSearch").focus(), 50);
}
function closeAssignModal(){ $("modalBack").style.display = "none"; }

$("openAssignBtn").addEventListener("click", ()=> openAssignModal({}));
$("closeModal").addEventListener("click", closeAssignModal);
$("finishAssignBtn").addEventListener("click", ()=>{ closeAssignModal(); toast("ƒê√£ l∆∞u v·ªã tr√≠"); });
$("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeAssignModal(); });

function assignQuick(productKey){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Thi·∫øu k·ªá/m√¢m"); return; }

  const typed = toInt($("modalPos").value);
  if(typed !== null) modalAssignPos = typed;

  const skipUsed = $("skipUsedToggle").checked;
  const pos = skipUsed ? getNextFreePos(tray, modalAssignPos) : Math.max(1, modalAssignPos);

  const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
  if(pos > maxPos){
    toast("V·ªã tr√≠ v∆∞·ª£t s·ªë √¥ c·ªßa m√¢m");
    $("modalNote").innerHTML = `‚ö†Ô∏è V·ªã tr√≠ <b>${pos}</b> v∆∞·ª£t s·ªë √¥ (<b>${maxPos}</b>).`;
    return;
  }

  const existedSlot = slotAtPos(tray, pos);
  let replacedKey = null;
  if(existedSlot && existedSlot.productKey !== productKey){
    replacedKey = existedSlot.productKey;
    tray.slots = tray.slots.filter(s=>s.pos !== pos);
    delete state.locIndex[replacedKey];
  }

  const oldLoc = state.locIndex[productKey] ? {...state.locIndex[productKey]} : null;
  removeProductFromOldLocation(productKey);

  tray.slots.push({pos, productKey});
  tray.slots.sort((a,b)=>a.pos-b.pos);
  state.locIndex[productKey] = {shelfId: shelf.id, trayId: tray.id, pos};

  modalHistory.push({productKey, newLoc:{shelfId:shelf.id, trayId:tray.id, pos}, oldLoc, replacedKey});
  save();

  modalAssignedCount++;
  modalAssignPos = pos + 1;
  $("modalPos").value = String(modalAssignPos);

  const p = productByKey(productKey);
  const qv = getStockQtyForProductKey(productKey);
  $("modalNote").innerHTML =
    `ƒê√£ g√°n <b>${escapeHtml(p?.name || productKey)}</b> ‚Üí V·ªã tr√≠ <b>${pos}</b> ‚Ä¢ SKU: <b class="mono">${escapeHtml(p?.sku || "‚Äî")}</b> ‚Ä¢ T·ªìn: <b>${escapeHtml(fmtQty(qv))}</b> ‚Ä¢ T·ªïng: <b>${modalAssignedCount}</b>`;

  toast(`G√°n v·ªã tr√≠ ${pos}`);
  selectedPos = pos;
  renderTrayGrid(); renderTrayList(); renderLookup();

  if($("autoCloseToggle").checked) closeAssignModal();
}

$("undoAssignBtn").addEventListener("click", ()=>{
  const last = modalHistory.pop();
  if(!last){ toast("Kh√¥ng c√≥ g√¨ ƒë·ªÉ ho√†n t√°c"); return; }

  const newShelf = state.shelves.find(s=>s.id===last.newLoc.shelfId);
  const newTray  = newShelf?.trays?.find(t=>t.id===last.newLoc.trayId);
  if(newTray){
    newTray.slots = newTray.slots.filter(sl=> !(sl.productKey===last.productKey && sl.pos===last.newLoc.pos));
  }

  if(last.replacedKey){
    newTray?.slots?.push({pos:last.newLoc.pos, productKey:last.replacedKey});
    newTray?.slots?.sort((a,b)=>a.pos-b.pos);
    if(newShelf && newTray) state.locIndex[last.replacedKey] = {shelfId:newShelf.id, trayId:newTray.id, pos:last.newLoc.pos};
  }

  if(last.oldLoc){
    const oldShelf = state.shelves.find(s=>s.id===last.oldLoc.shelfId);
    const oldTray  = oldShelf?.trays?.find(t=>t.id===last.oldLoc.trayId);
    if(oldTray){
      oldTray.slots.push({pos:last.oldLoc.pos, productKey:last.productKey});
      oldTray.slots.sort((a,b)=>a.pos-b.pos);
    }
    state.locIndex[last.productKey] = last.oldLoc;
  }else{
    delete state.locIndex[last.productKey];
  }

  save();
  modalAssignedCount = Math.max(0, modalAssignedCount-1);

  const curTray = getSelectedTray();
  if(curTray){
    const typed = toInt($("modalPos").value);
    modalAssignPos = Math.max(1, (typed ?? (last.newLoc.pos+1)) - 1);
    if($("skipUsedToggle").checked) modalAssignPos = getNextFreePos(curTray, modalAssignPos);
    $("modalPos").value = String(modalAssignPos);
  }

  renderTrayGrid(); renderTrayList(); renderLookup(); toast("ƒê√£ ho√†n t√°c");
});

function renderModalPick(){
  const q = norm($("modalSearch").value);
  const list = $("modalPickList");
  list.innerHTML = "";

  if(!q){ $("modalEmpty").style.display = "block"; return; }
  $("modalEmpty").style.display = "none";

  const arr = state.products
    .filter(p=> p.key.includes(q) || normSku(p.sku).includes(q))
    .slice(0, 80);

  if(!arr.length){
    const p = document.createElement("p");
    p.className = "small";
    p.textContent = "Kh√¥ng th·∫•y trong danh s√°ch master.";
    list.appendChild(p);
    return;
  }

  arr.forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const qv = getStockQtyForProductKey(p.key);
    const qcls = qtyClass(qv);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta">SKU: <b class="mono">${escapeHtml(p.sku || "‚Äî")}</b></div>
          <div class="meta">T·ªìn: <b class="${qcls}">${escapeHtml(fmtQty(qv))}</b></div>
          <div class="meta small">üëâ Ch·∫°m ƒë·ªÉ g√°n v√†o v·ªã tr√≠ hi·ªán t·∫°i</div>
        </div>
        <div class="actions"><button class="primary">Ch·∫°m ƒë·ªÉ g√°n</button></div>
      </div>
    `;
    const doAssign = ()=> assignQuick(p.key);
    item.addEventListener("click", doAssign);
    item.querySelector("button").addEventListener("click",(e)=>{e.stopPropagation(); doAssign();});
    list.appendChild(item);
  });
}
$("modalSearch").addEventListener("input", debounce(renderModalPick, 180));

function renderTrayList(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  const list = $("trayList");
  list.innerHTML = "";

  if(!shelf || !tray){
    $("trayEmpty").style.display = "block";
    $("layoutInfo").textContent = "";
    return;
  }

  const q = norm($("traySearch").value);
  const sort = $("traySort").value;

  let arr = tray.slots.slice();
  if(q){
    arr = arr.filter(sl=>{
      const p = productByKey(sl.productKey);
      const name = p?.name || sl.productKey;
      const sku = normSku(p?.sku || "");
      return norm(name).includes(q) || sku.includes(q);
    });
  }

  if(sort==="posAsc") arr.sort((a,b)=>a.pos-b.pos);
  if(sort==="posDesc") arr.sort((a,b)=>b.pos-a.pos);
  if(sort==="nameAsc") arr.sort((a,b)=> productNameByKey(a.productKey).localeCompare(productNameByKey(b.productKey),"vi"));
  if(sort==="nameDesc") arr.sort((a,b)=> productNameByKey(b.productKey).localeCompare(productNameByKey(a.productKey),"vi"));

  $("trayEmpty").style.display = tray.slots.length ? "none" : "block";
  $("layoutInfo").innerHTML = `
    <span class="tag"><strong>${escapeHtml(shelf.name)}</strong></span>
    <span class="tag"><strong>${escapeHtml(tray.name)}</strong></span>
    <span class="tag">T·ªïng SP: <strong>${tray.slots.length}</strong></span>
  `;

  arr.forEach(sl=>{
    const p = productByKey(sl.productKey);
    const prodName = p?.name ?? sl.productKey;
    const sku = p?.sku ?? "";
    const qv = getStockQtyForProductKey(sl.productKey);
    const qcls = qtyClass(qv);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(prodName)}</div>
          <div class="meta">V·ªã tr√≠: <b>${sl.pos}</b></div>
          <div class="meta">SKU: <b class="mono">${escapeHtml(sku || "‚Äî")}</b></div>
          <div class="meta">T·ªìn: <b class="${qcls}">${escapeHtml(fmtQty(qv))}</b></div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="ghost" data-act="move">üîÅ ƒê·ªïi v·ªã tr√≠</button>
          <button class="danger" data-act="del">üóëÔ∏è Xo√°</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${prodName} ‚Äî SKU: ${sku || "‚Äî"} ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${sl.pos} ‚Äî T·ªìn: ${fmtQty(qv)}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }catch(e){ alert(line); }
    });

    item.querySelector('[data-act="move"]').addEventListener("click", ()=>{
      const np = prompt(`ƒê·ªïi v·ªã tr√≠ cho "${prodName}" (hi·ªán: ${sl.pos})`, String(sl.pos));
      if(np===null) return;
      const npos = toInt(np);
      if(npos===null || npos<=0){ toast("V·ªã tr√≠ ph·∫£i > 0"); return; }

      const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
      if(npos > maxPos){ toast("V∆∞·ª£t s·ªë √¥ c·ªßa m√¢m"); return; }

      const existed = slotAtPos(tray, npos);
      if(existed && existed.productKey !== sl.productKey){
        const existedName = productNameByKey(existed.productKey);
        if(!confirm(`V·ªã tr√≠ ${npos} ƒëang c√≥ "${existedName}". Thay th·∫ø?`)) return;
        delete state.locIndex[existed.productKey];
        tray.slots = tray.slots.filter(x=>x.pos!==npos);
      }

      sl.pos = npos;
      tray.slots.sort((a,b)=>a.pos-b.pos);
      state.locIndex[sl.productKey] = {shelfId:shelf.id, trayId:tray.id, pos:npos};
      selectedPos = npos;
      save(); renderTrayGrid(); renderTrayList(); renderLookup(); toast("ƒê√£ ƒë·ªïi v·ªã tr√≠");
    });

    item.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      if(!confirm(`Xo√° "${prodName}" kh·ªèi ${shelf.name} - ${tray.name}?`)) return;
      tray.slots = tray.slots.filter(x=>x.productKey !== sl.productKey);
      delete state.locIndex[sl.productKey];
      if(selectedPos === sl.pos) selectedPos = null;
      save(); renderTrayGrid(); renderTrayList(); renderLookup(); toast("ƒê√£ xo√°");
    });

    list.appendChild(item);
  });
}

$("traySearch").addEventListener("input", debounce(renderTrayList, 160));
$("traySort").addEventListener("change", renderTrayList);

/* =========================
   Lookup
========================= */
function renderLookupShelves(){
  const sel = $("lookupShelf");
  const cur = sel.value;
  sel.innerHTML = `<option value="">T·∫•t c·∫£ k·ªá</option>`;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  sel.value = cur || "";
}

function scoreMatch(qKey, pKey){
  if(!qKey) return 0;
  if(pKey === qKey) return 1000;
  if(pKey.startsWith(qKey)) return 600 + qKey.length;
  if(pKey.includes(qKey)) return 300 + qKey.length;
  const parts = qKey.split(" ").filter(Boolean);
  let hit=0;
  for(const w of parts) if(pKey.includes(w)) hit++;
  return hit ? (100 + hit*10) : 0;
}

function renderLookup(){
  renderLookupShelves();

  const q = norm($("lookupInput").value);
  const shelfFilter = $("lookupShelf").value;
  const result = $("lookupResult");
  const empty = $("lookupEmpty");
  result.innerHTML = "";

  if(!q){
    empty.textContent = "Ch∆∞a c√≥ k·∫øt qu·∫£.";
    empty.style.display = "block";
    return;
  }

  let pool = state.products.length ? state.products : Object.keys(state.locIndex).map(k=>({name:k, key:k, sku:""}));

  let scored = pool
    .map(p=>({p, score: scoreMatch(q, p.key) + (normSku(p.sku).includes(q) ? 500 : 0)}))
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0, 30);

  if(!scored.length){
    empty.textContent = "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  scored.forEach(({p})=>{
    const loc = state.locIndex?.[p.key];
    if(shelfFilter && (!loc || loc.shelfId !== shelfFilter)) return;

    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const qv = getStockQtyForProductKey(p.key);
    const qcls = qtyClass(qv);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta">SKU: <b class="mono">${escapeHtml(p.sku || "‚Äî")}</b></div>
          <div class="meta">T·ªìn: <b class="${qcls}">${escapeHtml(fmtQty(qv))}</b></div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="primary" data-act="jump">üß≠ ƒêi t·ªõi</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî SKU: ${p.sku || "‚Äî"} ‚Äî ${locText} ‚Äî T·ªìn: ${fmtQty(qv)}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }catch(e){ alert(line); }
    });

    item.querySelector('[data-act="jump"]').addEventListener("click", ()=>{
      if(!loc){ toast("S·∫£n ph·∫©m ch∆∞a g√°n v·ªã tr√≠"); return; }
      document.querySelector('.tab[data-tab="layout"]').click();
      $("shelfSelect").value = loc.shelfId;
      ensureTraySelect();
      $("traySelect").value = loc.trayId;
      selectedPos = loc.pos;
      renderTrayGrid(); renderTrayList(); toast("ƒê√£ m·ªü ƒë√∫ng k·ªá/m√¢m");
    });

    result.appendChild(item);
  });

  if(!result.children.length){
    empty.textContent = "C√≥ k·∫øt qu·∫£ nh∆∞ng kh√¥ng n·∫±m trong k·ªá b·∫°n ƒëang l·ªçc.";
    empty.style.display = "block";
  }
}
$("lookupInput").addEventListener("input", debounce(renderLookup, 160));
$("lookupShelf").addEventListener("change", renderLookup);

/* =========================
   Backup
========================= */
$("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "vi-tri-san-pham-backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("ƒê√£ export JSON");
});

$("importBtn").addEventListener("click", ()=> $("jsonFile").click());
$("jsonFile").addEventListener("change", async ()=>{
  const f = $("jsonFile").files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!obj || typeof obj !== "object") throw new Error("invalid");

    obj.products ??= [];
    obj.shelves ??= [];
    obj.locIndex ??= {};
    obj.stock ??= {skuIndex:{}, nameIndex:{}, fileName:"", updatedAt:"", colSku:"", colName:"", colQty:"", rowsCount:0, keysCount:0, match:{totalMaster:0, masterWithSku:0, matchedSku:0}};
    obj.stock.skuIndex ??= {};
    obj.stock.nameIndex ??= {};
    obj.stock.match ??= {totalMaster:0, masterWithSku:0, matchedSku:0};

    state = obj;
    state.products = (state.products||[]).map(p=>({
      id: p.id || uid("SP"),
      name: p.name ?? "",
      key: p.key ?? norm(p.name ?? ""),
      sku: p.sku ?? ""
    }));
    rebuildProductMap();
    calcMatchStats();

    save(); renderAll(); toast("ƒê√£ import JSON");
  }catch(e){
    alert("File JSON kh√¥ng h·ª£p l·ªá.");
  }finally{
    $("jsonFile").value = "";
  }
});

$("resetAllBtn").addEventListener("click", ()=>{
  if(!confirm("Xo√° T·∫§T C·∫¢ d·ªØ li·ªáu (SP + k·ªá + v·ªã tr√≠ + t·ªìn)?")) return;
  state = {
    products:[],
    shelves:[],
    locIndex:{},
    stock:{skuIndex:{}, nameIndex:{}, fileName:"", updatedAt:"", colSku:"", colName:"", colQty:"", rowsCount:0, keysCount:0, match:{totalMaster:0, masterWithSku:0, matchedSku:0}}
  };
  rebuildProductMap();
  save();
  renderAll();
  toast("ƒê√£ reset");
});

/* =========================
   Layout render + init
========================= */
function renderLayout(){
  ensureShelfSelect();
  ensureTraySelect();
  renderTrayGrid();
  renderTrayList();
  renderLookupShelves();
}

function renderAll(){
  refreshStatus();
  renderProducts();
  renderLookup();
  renderLayout();
}

load();
save();
renderAll();
</script>
</body>
</html>