<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>V·ªä TR√ç S·∫¢N PH·∫®M</title>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#1976d2;
      --primary2:#64b5f6;
      --danger:#d32f2f;
      --warn:#ef6c00;
      --ok:#1b5e20;
      --border:#e2e8f0;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(25,118,210,.18), transparent 55%),
        radial-gradient(1000px 400px at 90% 0%, rgba(100,181,246,.25), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 12px 25px rgba(25,118,210,.22);
      display:grid;place-items:center;
      color:#fff; font-weight:900;
    }
    .title h1{font-size:18px;margin:0}
    .title p{margin:2px 0 0; color:var(--muted); font-size:13px}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#f1f5f9;border:1px solid var(--border);
      color:var(--muted);font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .ok{background:#e8f7ee; color:#14532d; border-color: rgba(27,94,32,.2)}
    .warn{background:#fff4e5; color:#7c2d12; border-color: rgba(239,108,0,.25)}
    .bad{background:#ffe8e8; color:#7f1d1d; border-color: rgba(211,50,47,.25)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      color:#0f172a;
    }
    .tab.active{
      border-color: rgba(25,118,210,.45);
      box-shadow: 0 10px 25px rgba(25,118,210,.12);
      background: linear-gradient(135deg, rgba(25,118,210,.1), rgba(100,181,246,.1));
    }
    .row{display:grid; gap:12px}
    @media (min-width:900px){
      .row{grid-template-columns: 1fr 1fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex; gap:8px; align-items:center;
    }
    .hint{color:var(--muted); font-size:12.5px; margin:0 0 10px;}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px;}
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 12px 12px;
      font-size:15px;
      outline:none;
      transition:.15s;
    }
    textarea{min-height:140px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(25,118,210,.65);
      box-shadow:0 0 0 4px rgba(25,118,210,.12)
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:0; border-radius: 14px;
      padding: 11px 12px;
      font-weight:900;
      cursor:pointer;
      background:#eaf2ff;
      color:#0b3b7a;
    }
    button.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      box-shadow:0 12px 25px rgba(25,118,210,.22);
    }
    button.ghost{background:#f1f5f9; color:#0f172a;}
    button.danger{background:#ffe8e8; color:#7f1d1d;}
    button:active{transform: translateY(1px)}
    .divider{height:1px;background:var(--border); margin:12px 0;}

    .list{display:grid; gap:10px;}
    .item{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:12px;
      background:#fff;
      display:grid; gap:10px;
    }
    .itemTop{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .name{font-weight:900;font-size:15px;line-height:1.25;}
    .meta{margin-top:4px;color:var(--muted);font-size:12.5px;}
    .actions{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;}
    .actions button{padding:9px 10px;border-radius:12px;font-weight:900;font-size:13px;}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .grid2{display:grid; gap:10px; grid-template-columns:1fr;}
    @media (min-width:520px){ .grid2{grid-template-columns:1fr 1fr;} }

    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .tag strong{color:#0f172a}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none; align-items:flex-end; justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(980px,100%);
      background:#fff;
      border-radius: 18px 18px 0 0;
      padding:14px;
      border:1px solid var(--border);
      box-shadow: 0 -20px 50px rgba(0,0,0,.25);
      max-height: 86vh;
      overflow:auto;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:15px;}
    .xbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(15,23,42,.92); color:#fff;
      padding:10px 14px; border-radius:14px;
      font-weight:900; z-index:99999;
      box-shadow:0 12px 30px rgba(0,0,0,.22);
      opacity:0; pointer-events:none;
      transition: opacity .2s;
    }

    .hidden{display:none !important}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">VT</div>
      <div class="title">
        <h1>V·ªã tr√≠ s·∫£n ph·∫©m (K·ªá ‚Üí M√¢m ‚Üí V·ªã tr√≠)</h1>
        <p>Nh·∫≠p danh s√°ch SP ‚Üí t·∫°o k·ªá/m√¢m ‚Üí g√°n v·ªã tr√≠ ‚Üí t√¨m t√™n l√† ra ngay.</p>
      </div>
    </div>
    <div class="pill" id="statusPill">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="lookup">üîé Tra c·ª©u</div>
    <div class="tab" data-tab="layout">üß≠ S∆° ƒë·ªì k·ªá</div>
    <div class="tab" data-tab="products">üì¶ Danh s√°ch s·∫£n ph·∫©m</div>
    <div class="tab" data-tab="backup">üõü Sao l∆∞u</div>
  </div>

  <!-- LOOKUP -->
  <div id="tab-lookup" class="card">
    <h2>Tra c·ª©u v·ªã tr√≠ theo t√™n s·∫£n ph·∫©m</h2>
    <p class="hint">G√µ t√™n (c√≥ th·ªÉ g√µ m·ªôt ph·∫ßn) ‚Üí tool s·∫Ω ∆∞u ti√™n kh·ªõp g·∫ßn ƒë√∫ng.</p>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m</label>
        <input id="lookupInput" placeholder="VD: m√¨ h·∫£o h·∫£o..." autocomplete="off"/>
      </div>
      <div>
        <label>L·ªçc theo k·ªá (tu·ª≥ ch·ªçn)</label>
        <select id="lookupShelf">
          <option value="">T·∫•t c·∫£ k·ªá</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>
    <div id="lookupResult" class="list"></div>
    <p id="lookupEmpty" class="small">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>
  </div>

  <!-- LAYOUT -->
  <div id="tab-layout" class="hidden">
    <div class="row">
      <div class="card">
        <h2>T·∫°o / qu·∫£n l√Ω k·ªá</h2>
        <div class="grid2">
          <div>
            <label>T√™n k·ªá</label>
            <input id="newShelfName" placeholder="VD: K·ªá 30" />
          </div>
          <div>
            <label>S·ªë m√¢m trong k·ªá</label>
            <input id="newShelfTrays" inputmode="numeric" placeholder="VD: 5" value="5" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="createShelfBtn">‚ûï T·∫°o k·ªá</button>
          <button class="ghost" id="renameShelfBtn">‚úèÔ∏è ƒê·ªïi t√™n k·ªá</button>
          <button class="danger" id="deleteShelfBtn">üóëÔ∏è Xo√° k·ªá</button>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label>Ch·ªçn k·ªá ƒë·ªÉ thao t√°c</label>
            <select id="shelfSelect"></select>
          </div>
          <div>
            <label>Ch·ªçn m√¢m</label>
            <select id="traySelect"></select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="assignBtn">üìå G√°n s·∫£n ph·∫©m v√†o m√¢m</button>
          <button class="ghost" id="trayRenameBtn">‚úèÔ∏è ƒê·ªïi t√™n m√¢m</button>
          <button class="danger" id="trayClearBtn">üßπ Xo√° to√†n b·ªô SP trong m√¢m</button>
        </div>

        <p class="small" id="layoutInfo" style="margin-top:10px;"></p>
      </div>

      <div class="card">
        <h2>Danh s√°ch trong m√¢m</h2>
        <p class="hint">M·ªói s·∫£n ph·∫©m n·∫±m ƒë√∫ng 1 v·ªã tr√≠ duy nh·∫•t. N·∫øu g√°n l·∫°i, tool s·∫Ω h·ªèi c√≥ ‚Äúchuy·ªÉn v·ªã tr√≠‚Äù kh√¥ng.</p>

        <div class="grid2">
          <div>
            <label>T√¨m nhanh trong m√¢m</label>
            <input id="traySearch" placeholder="g√µ ƒë·ªÉ l·ªçc..." autocomplete="off"/>
          </div>
          <div>
            <label>S·∫Øp x·∫øp</label>
            <select id="traySort">
              <option value="posAsc">V·ªã tr√≠ ‚Üë</option>
              <option value="posDesc">V·ªã tr√≠ ‚Üì</option>
              <option value="nameAsc">T√™n A‚ÜíZ</option>
              <option value="nameDesc">T√™n Z‚ÜíA</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <div id="trayList" class="list"></div>
        <p id="trayEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m trong m√¢m n√†y.</p>
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="tab-products" class="hidden">
    <div class="row">
      <div class="card">
        <h2>Nh·∫≠p danh s√°ch s·∫£n ph·∫©m (master)</h2>
        <p class="hint">M·ªói d√≤ng 1 s·∫£n ph·∫©m. V√≠ d·ª•: <b>M√¨ H·∫£o H·∫£o T√¥m Chua Cay 75G</b></p>
        <textarea id="productTextarea" placeholder="D√°n danh s√°ch s·∫£n ph·∫©m v√†o ƒë√¢y..."></textarea>
        <div class="btns">
          <button class="primary" id="addProductsBtn">‚úÖ Th√™m / c·∫≠p nh·∫≠t danh s√°ch</button>
          <button class="ghost" id="importCSVBtn">‚¨ÜÔ∏è Import CSV</button>
          <input id="csvFile" type="file" accept=".csv" class="hidden" />
          <button class="danger" id="clearProductsBtn">üóëÔ∏è Xo√° danh s√°ch SP</button>
        </div>
        <p class="small" id="productStats"></p>
      </div>

      <div class="card">
        <h2>Danh s√°ch s·∫£n ph·∫©m hi·ªán c√≥</h2>
        <div class="grid2">
          <div>
            <label>T√¨m trong master</label>
            <input id="masterSearch" placeholder="g√µ ƒë·ªÉ l·ªçc..." autocomplete="off"/>
          </div>
          <div>
            <label>Hi·ªÉn th·ªã</label>
            <select id="masterLimit">
              <option value="50">50 d√≤ng</option>
              <option value="150">150 d√≤ng</option>
              <option value="500">500 d√≤ng</option>
            </select>
          </div>
        </div>
        <div class="divider"></div>
        <div id="masterList" class="list"></div>
        <p id="masterEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m. H√£y nh·∫≠p danh s√°ch ·ªü b√™n tr√°i.</p>
      </div>
    </div>
  </div>

  <!-- BACKUP -->
  <div id="tab-backup" class="card hidden">
    <h2>Sao l∆∞u / kh√¥i ph·ª•c</h2>
    <p class="hint">D·ªØ li·ªáu ƒëang l∆∞u trong m√°y (localStorage). B·∫°n n√™n export JSON ƒë·ªÉ backup.</p>

    <div class="btns">
      <button class="primary" id="exportBtn">‚¨áÔ∏è Export JSON</button>
      <button class="ghost" id="importBtn">‚¨ÜÔ∏è Import JSON</button>
      <input id="jsonFile" type="file" accept=".json" class="hidden" />
      <button class="danger" id="resetAllBtn">üß® Xo√° t·∫•t c·∫£ d·ªØ li·ªáu</button>
    </div>

    <div class="divider"></div>
    <p class="small mono" id="backupInfo"></p>
  </div>
</div>

<!-- MODAL: Assign product -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">G√°n s·∫£n ph·∫©m</h3>
      <button class="xbtn" id="closeModal">‚úï</button>
    </div>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m (master)</label>
        <input id="modalSearch" placeholder="g√µ t√™n s·∫£n ph·∫©m..." autocomplete="off"/>
      </div>
      <div>
        <label>V·ªã tr√≠ (s·ªë)</label>
        <input id="modalPos" inputmode="numeric" placeholder="VD: 1" />
      </div>
    </div>

    <div class="divider"></div>
    <div id="modalPickList" class="list"></div>
    <p id="modalEmpty" class="small">G√µ ƒë·ªÉ t√¨m s·∫£n ph·∫©m r·ªìi ch·ªçn.</p>

    <div class="divider"></div>
    <div class="btns">
      <button class="primary" id="confirmAssignBtn">üìå G√°n v√†o v·ªã tr√≠</button>
      <button class="ghost" id="cancelAssignBtn">Hu·ª∑</button>
    </div>
    <p class="small" id="modalNote" style="margin-top:10px;"></p>
  </div>
</div>

<div id="toast">OK</div>

<script>
/* =========================
   Data model
========================= */
const LS_KEY = "vitri_sanpham_v1";

function removeAccents(str){
  return (str || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}
function norm(str){
  const s = String(str ?? "").trim().replace(/\s+/g," ");
  return removeAccents(s).toUpperCase();
}
function uid(prefix="ID"){
  return prefix + "_" + Math.random().toString(36).slice(2,10).toUpperCase();
}
function debounce(fn, ms=200){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function toInt(v){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : null;
}

let state = {
  products: [], // [{id, name, key}]
  shelves: [],  // [{id, name, trays:[{id,name, slots:[{pos, productKey}]}]}]
  locIndex: {}  // productKey -> {shelfId, trayId, pos}
};

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      state = JSON.parse(raw);
      // basic repairs
      state.products ??= [];
      state.shelves ??= [];
      state.locIndex ??= {};
    }
  }catch(e){}
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  refreshStatus();
}

/* =========================
   UI helpers
========================= */
const $ = (id)=>document.getElementById(id);

const statusPill = $("statusPill");
function refreshStatus(){
  const p = state.products.length;
  const s = state.shelves.length;
  const a = Object.keys(state.locIndex || {}).length;

  statusPill.className = "pill " + (a ? "ok" : (p || s ? "warn" : ""));
  statusPill.textContent = `SP: ${p} ‚Ä¢ K·ªá: ${s} ‚Ä¢ ƒê√£ g√°n: ${a}`;
  $("backupInfo").textContent = `products=${p}, shelves=${s}, assigned=${a}, key=${LS_KEY}`;
}

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.opacity="0", 1100);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const key = tab.dataset.tab;
    ["lookup","layout","products","backup"].forEach(k=>{
      const el = $("tab-"+k);
      if(k===key) el.classList.remove("hidden");
      else el.classList.add("hidden");
    });
    renderAll();
  });
});

/* =========================
   Products (master)
========================= */
function mergeProductsFromLines(lines){
  const set = new Map(state.products.map(p=>[p.key, p]));
  let added=0;
  for(const line of lines){
    const name = String(line ?? "").trim();
    if(!name) continue;
    const key = norm(name);
    if(!key) continue;
    if(!set.has(key)){
      const obj = {id: uid("SP"), name, key};
      set.set(key, obj);
      added++;
    }
  }
  state.products = Array.from(set.values())
    .sort((a,b)=>a.name.localeCompare(b.name,"vi"));
  save();
  toast(`ƒê√£ c·∫≠p nh·∫≠t danh s√°ch (+${added})`);
}

$("addProductsBtn").addEventListener("click", ()=>{
  const lines = $("productTextarea").value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(!lines.length){
    toast("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ th√™m");
    return;
  }
  mergeProductsFromLines(lines);
  $("productTextarea").value = "";
  renderProducts();
  renderLookup();
});

$("clearProductsBtn").addEventListener("click", ()=>{
  if(!state.products.length){ toast("Danh s√°ch SP ƒëang tr·ªëng"); return; }
  if(confirm("Xo√° to√†n b·ªô danh s√°ch s·∫£n ph·∫©m (master)?")){
    state.products = [];
    // kh√¥ng auto xo√° v·ªã tr√≠, nh∆∞ng tra c·ª©u master s·∫Ω kh√≥. B·∫°n c√≥ th·ªÉ reset all ·ªü tab Sao l∆∞u.
    save();
    renderProducts();
    renderLookup();
    toast("ƒê√£ xo√° danh s√°ch SP");
  }
});

$("importCSVBtn").addEventListener("click", ()=> $("csvFile").click());

$("csvFile").addEventListener("change", async ()=>{
  const f = $("csvFile").files?.[0];
  if(!f) return;
  const text = await f.text();
  const lines = parseCSVToNames(text);
  mergeProductsFromLines(lines);
  $("csvFile").value = "";
  renderProducts();
  renderLookup();
});

function parseCSVToNames(text){
  // l·∫•y c·ªôt ƒë·∫ßu ti√™n, ho·∫∑c c·ªôt c√≥ header "Ten", "Name"
  const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  if(!lines.length) return [];
  const parseLine = (line)=>{
    const out=[];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch === "," && !inQ){
        out.push(cur); cur="";
      }else cur += ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };

  const header = parseLine(lines[0]).map(h=>removeAccents(h).toLowerCase());
  let idx = 0;
  const nameIdx = header.findIndex(h=> h.includes("ten") || h.includes("name") || h.includes("product"));
  if(nameIdx >= 0) idx = nameIdx;

  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols = parseLine(lines[i]);
    const name = cols[idx] ?? cols[0] ?? "";
    if(String(name).trim()) out.push(String(name).trim());
  }
  return out;
}

function renderProducts(){
  const q = norm($("masterSearch").value);
  const limit = parseInt($("masterLimit").value,10) || 50;

  let arr = state.products;
  if(q){
    arr = arr.filter(p=> p.key.includes(q) || norm(p.name).includes(q));
  }

  $("productStats").textContent = `T·ªïng s·∫£n ph·∫©m: ${state.products.length} ‚Ä¢ ƒêang hi·ªÉn th·ªã: ${Math.min(arr.length, limit)}`;

  const list = $("masterList");
  list.innerHTML = "";
  $("masterEmpty").style.display = state.products.length ? "none" : "block";

  arr.slice(0, limit).forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta mono">${p.key}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
        </div>
      </div>
    `;
    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî ${locText}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });
    list.appendChild(item);
  });
}

$("masterSearch").addEventListener("input", debounce(renderProducts, 220));
$("masterLimit").addEventListener("change", renderProducts);

/* =========================
   Shelves / trays / slots
========================= */
function ensureShelfSelect(){
  const sel = $("shelfSelect");
  sel.innerHTML = "";
  if(!state.shelves.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ k·ªá";
    sel.appendChild(op);
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  if(!sel.value) sel.value = state.shelves[0].id;
}

function ensureTraySelect(){
  const shelfId = $("shelfSelect").value;
  const traySel = $("traySelect");
  traySel.innerHTML = "";
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf || !shelf.trays?.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ m√¢m";
    traySel.appendChild(op);
    traySel.disabled = true;
    return;
  }
  traySel.disabled = false;
  shelf.trays.forEach(t=>{
    const op = document.createElement("option");
    op.value = t.id;
    op.textContent = t.name;
    traySel.appendChild(op);
  });
  if(!traySel.value) traySel.value = shelf.trays[0].id;
}

function createShelf(name, trayCount){
  const n = String(name ?? "").trim();
  if(!n){ toast("Nh·∫≠p t√™n k·ªá"); return; }
  const count = toInt(trayCount) ?? 5;
  const trays = Array.from({length: Math.max(1, count)}, (_,i)=>({
    id: uid("MAM"),
    name: `M√¢m ${i+1}`,
    slots: []
  }));
  state.shelves.push({
    id: uid("KE"),
    name: n,
    trays
  });
  save();
  toast("ƒê√£ t·∫°o k·ªá");
}

$("createShelfBtn").addEventListener("click", ()=>{
  createShelf($("newShelfName").value, $("newShelfTrays").value);
  $("newShelfName").value = "";
  renderLayout();
  renderLookup();
});

$("renameShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }
  const n = prompt("ƒê·ªïi t√™n k·ªá:", shelf.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  shelf.name = nn;
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ ƒë·ªïi t√™n k·ªá");
});

$("deleteShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }

  const assignedInShelf = countAssignedInShelf(shelfId);
  const msg = assignedInShelf
    ? `K·ªá n√†y ƒëang c√≥ ${assignedInShelf} SP ƒë√£ g√°n. Xo√° k·ªá s·∫Ω xo√° lu√¥n c√°c v·ªã tr√≠ ƒë√≥. Ti·∫øp t·ª•c?`
    : "Xo√° k·ªá n√†y?";

  if(!confirm(msg)) return;

  // remove assignments in this shelf
  const keysToRemove = Object.keys(state.locIndex).filter(k=>state.locIndex[k].shelfId === shelfId);
  keysToRemove.forEach(k=> delete state.locIndex[k]);

  // remove shelf
  state.shelves = state.shelves.filter(s=>s.id!==shelfId);
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ xo√° k·ªá");
});

function countAssignedInShelf(shelfId){
  let c=0;
  for(const k in state.locIndex){
    if(state.locIndex[k].shelfId === shelfId) c++;
  }
  return c;
}

$("shelfSelect").addEventListener("change", ()=>{
  ensureTraySelect();
  renderTrayList();
  renderLookupShelves();
});

$("traySelect").addEventListener("change", renderTrayList);

$("trayRenameBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }
  const n = prompt("ƒê·ªïi t√™n m√¢m:", tray.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  tray.name = nn;
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ ƒë·ªïi t√™n m√¢m");
});

$("trayClearBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }

  const count = tray.slots.length;
  if(!count){ toast("M√¢m ƒëang tr·ªëng"); return; }
  if(!confirm(`Xo√° to√†n b·ªô ${count} SP trong ${shelf.name} - ${tray.name}?`)) return;

  // remove locIndex for those products
  tray.slots.forEach(sl=>{
    if(state.locIndex[sl.productKey]) delete state.locIndex[sl.productKey];
  });
  tray.slots = [];
  save();
  renderTrayList();
  renderLookup();
  toast("ƒê√£ xo√° SP trong m√¢m");
});

function getSelectedShelf(){
  const id = $("shelfSelect").value;
  return state.shelves.find(s=>s.id===id);
}
function getSelectedTray(){
  const shelf = getSelectedShelf();
  if(!shelf) return null;
  const tid = $("traySelect").value;
  return shelf.trays.find(t=>t.id===tid);
}

function formatLoc(loc){
  const shelf = state.shelves.find(s=>s.id===loc.shelfId);
  const tray = shelf?.trays?.find(t=>t.id===loc.trayId);
  const shelfName = shelf?.name ?? "(k·ªá ƒë√£ xo√°)";
  const trayName = tray?.name ?? "(m√¢m ƒë√£ xo√°)";
  return `${shelfName} ‚Ä¢ ${trayName} ‚Ä¢ V·ªã tr√≠ ${loc.pos}`;
}

/* =========================
   Assign modal
========================= */
let modalPickedKey = null;

function openModal(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){
    toast("C·∫ßn ch·ªçn k·ªá v√† m√¢m tr∆∞·ªõc");
    return;
  }
  modalPickedKey = null;
  $("modalTitle").textContent = `G√°n s·∫£n ph·∫©m v√†o: ${shelf.name} ‚Üí ${tray.name}`;
  $("modalSearch").value = "";
  $("modalPos").value = "";
  $("modalNote").textContent = "";
  $("modalPickList").innerHTML = "";
  $("modalEmpty").style.display = "block";
  $("modalBack").style.display = "flex";
  setTimeout(()=> $("modalSearch").focus(), 50);
}
function closeModal(){
  $("modalBack").style.display = "none";
}

$("assignBtn").addEventListener("click", openModal);
$("closeModal").addEventListener("click", closeModal);
$("cancelAssignBtn").addEventListener("click", closeModal);
$("modalBack").addEventListener("click", (e)=>{
  if(e.target === $("modalBack")) closeModal();
});

function renderModalPick(){
  const q = norm($("modalSearch").value);
  const list = $("modalPickList");
  list.innerHTML = "";

  if(!q){
    $("modalEmpty").style.display = "block";
    return;
  }
  $("modalEmpty").style.display = "none";

  const arr = state.products
    .filter(p=>p.key.includes(q))
    .slice(0, 50);

  if(!arr.length){
    const p = document.createElement("p");
    p.className = "small";
    p.textContent = "Kh√¥ng th·∫•y trong danh s√°ch master. (H√£y nh·∫≠p master ·ªü tab Danh s√°ch s·∫£n ph·∫©m)";
    list.appendChild(p);
    return;
  }

  arr.forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
        </div>
        <div class="actions">
          <button class="primary" data-pick>Ch·ªçn</button>
        </div>
      </div>
    `;
    item.querySelector("[data-pick]").addEventListener("click", ()=>{
      modalPickedKey = p.key;
      $("modalNote").innerHTML = `ƒê√£ ch·ªçn: <b>${escapeHtml(p.name)}</b>`;
      toast("ƒê√£ ch·ªçn s·∫£n ph·∫©m");
    });
    list.appendChild(item);
  });
}

$("modalSearch").addEventListener("input", debounce(renderModalPick, 200));

$("confirmAssignBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Thi·∫øu k·ªá/m√¢m"); return; }

  if(!modalPickedKey){
    toast("B·∫°n ch∆∞a ch·ªçn s·∫£n ph·∫©m");
    return;
  }
  const pos = toInt($("modalPos").value);
  if(pos === null || pos <= 0){
    toast("V·ªã tr√≠ ph·∫£i l√† s·ªë > 0");
    $("modalPos").focus();
    return;
  }

  // n·∫øu v·ªã tr√≠ ƒë√£ c√≥ sp
  const existedSlot = tray.slots.find(s=>s.pos === pos);
  if(existedSlot && existedSlot.productKey !== modalPickedKey){
    const existedName = state.products.find(p=>p.key===existedSlot.productKey)?.name ?? existedSlot.productKey;
    if(!confirm(`V·ªã tr√≠ ${pos} ƒëang c√≥ "${existedName}". Thay b·∫±ng s·∫£n ph·∫©m m·ªõi?`)){
      return;
    }
    // xo√° locIndex c·ªßa sp c≈©
    delete state.locIndex[existedSlot.productKey];
    // remove slot c≈©
    tray.slots = tray.slots.filter(s=>s.pos !== pos);
  }

  // n·∫øu sp ƒë√£ c√≥ v·ªã tr√≠ kh√°c
  const oldLoc = state.locIndex[modalPickedKey];
  if(oldLoc){
    const oldText = formatLoc(oldLoc);
    if(!confirm(`S·∫£n ph·∫©m n√†y ƒëang ·ªü: ${oldText}\nB·∫°n mu·ªën CHUY·ªÇN sang v·ªã tr√≠ m·ªõi?`)){
      return;
    }
    // remove from old tray slots
    const oldShelf = state.shelves.find(s=>s.id===oldLoc.shelfId);
    const oldTray = oldShelf?.trays?.find(t=>t.id===oldLoc.trayId);
    if(oldTray){
      oldTray.slots = oldTray.slots.filter(sl=>sl.productKey !== modalPickedKey);
    }
  }

  tray.slots.push({pos, productKey: modalPickedKey});
  tray.slots.sort((a,b)=>a.pos-b.pos);

  state.locIndex[modalPickedKey] = {shelfId: shelf.id, trayId: tray.id, pos};

  save();
  closeModal();
  renderTrayList();
  renderLookup();
  toast("ƒê√£ g√°n v·ªã tr√≠");
});

/* =========================
   Tray list render
========================= */
function renderTrayList(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  const list = $("trayList");
  list.innerHTML = "";

  if(!shelf || !tray){
    $("trayEmpty").style.display = "block";
    $("layoutInfo").textContent = "";
    return;
  }

  const q = norm($("traySearch").value);
  const sort = $("traySort").value;

  let arr = tray.slots.slice();
  if(q){
    arr = arr.filter(sl=>{
      const name = state.products.find(p=>p.key===sl.productKey)?.name ?? sl.productKey;
      return norm(name).includes(q);
    });
  }

  if(sort==="posAsc") arr.sort((a,b)=>a.pos-b.pos);
  if(sort==="posDesc") arr.sort((a,b)=>b.pos-a.pos);
  if(sort==="nameAsc") arr.sort((a,b)=>{
    const an = state.products.find(p=>p.key===a.productKey)?.name ?? "";
    const bn = state.products.find(p=>p.key===b.productKey)?.name ?? "";
    return an.localeCompare(bn,"vi");
  });
  if(sort==="nameDesc") arr.sort((a,b)=>{
    const an = state.products.find(p=>p.key===a.productKey)?.name ?? "";
    const bn = state.products.find(p=>p.key===b.productKey)?.name ?? "";
    return bn.localeCompare(an,"vi");
  });

  $("trayEmpty").style.display = tray.slots.length ? "none" : "block";
  $("layoutInfo").innerHTML = `
    <span class="tag"><strong>${escapeHtml(shelf.name)}</strong></span>
    <span class="tag"><strong>${escapeHtml(tray.name)}</strong></span>
    <span class="tag">T·ªïng SP: <strong>${tray.slots.length}</strong></span>
  `;

  arr.forEach(sl=>{
    const prod = state.products.find(p=>p.key===sl.productKey);
    const prodName = prod?.name ?? sl.productKey;

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(prodName)}</div>
          <div class="meta">V·ªã tr√≠: <b>${sl.pos}</b></div>
          <div class="meta mono">${escapeHtml(sl.productKey)}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="ghost" data-act="move">üîÅ ƒê·ªïi v·ªã tr√≠</button>
          <button class="danger" data-act="del">üóëÔ∏è Xo√°</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${prodName} ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${sl.pos}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });

    item.querySelector('[data-act="move"]').addEventListener("click", ()=>{
      const np = prompt(`ƒê·ªïi v·ªã tr√≠ cho "${prodName}" (hi·ªán: ${sl.pos})`, String(sl.pos));
      if(np===null) return;
      const npos = toInt(np);
      if(npos===null || npos<=0){ toast("V·ªã tr√≠ ph·∫£i > 0"); return; }

      // n·∫øu v·ªã tr√≠ m·ªõi ƒë√£ c√≥ sp kh√°c
      const existed = tray.slots.find(x=>x.pos===npos);
      if(existed && existed.productKey !== sl.productKey){
        const existedName = state.products.find(p=>p.key===existed.productKey)?.name ?? existed.productKey;
        if(!confirm(`V·ªã tr√≠ ${npos} ƒëang c√≥ "${existedName}". Thay th·∫ø?`)) return;
        delete state.locIndex[existed.productKey];
        tray.slots = tray.slots.filter(x=>x.pos!==npos);
      }

      // update slot
      sl.pos = npos;
      tray.slots.sort((a,b)=>a.pos-b.pos);
      state.locIndex[sl.productKey] = {shelfId:shelf.id, trayId:tray.id, pos:npos};
      save();
      renderTrayList();
      renderLookup();
      toast("ƒê√£ ƒë·ªïi v·ªã tr√≠");
    });

    item.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      if(!confirm(`Xo√° "${prodName}" kh·ªèi ${shelf.name} - ${tray.name}?`)) return;
      tray.slots = tray.slots.filter(x=>x.productKey !== sl.productKey);
      delete state.locIndex[sl.productKey];
      save();
      renderTrayList();
      renderLookup();
      toast("ƒê√£ xo√°");
    });

    list.appendChild(item);
  });
}

$("traySearch").addEventListener("input", debounce(renderTrayList, 180));
$("traySort").addEventListener("change", renderTrayList);

/* =========================
   Lookup
========================= */
function renderLookupShelves(){
  const sel = $("lookupShelf");
  const cur = sel.value;
  sel.innerHTML = `<option value="">T·∫•t c·∫£ k·ªá</option>`;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  sel.value = cur || "";
}

function scoreMatch(qKey, pKey){
  // ƒëi·ªÉm ƒë∆°n gi·∫£n: ch·ª©a nguy√™n c·ª•m => cao, b·∫Øt ƒë·∫ßu => cao h∆°n
  if(!qKey) return 0;
  if(pKey === qKey) return 1000;
  if(pKey.startsWith(qKey)) return 600 + qKey.length;
  if(pKey.includes(qKey)) return 300 + qKey.length;
  // fuzzy: m·ªói t·ª´ kh·ªõp
  const parts = qKey.split(" ").filter(Boolean);
  let hit=0;
  for(const w of parts) if(pKey.includes(w)) hit++;
  return hit ? (100 + hit*10) : 0;
}

function renderLookup(){
  renderLookupShelves();

  const q = norm($("lookupInput").value);
  const shelfFilter = $("lookupShelf").value;

  const result = $("lookupResult");
  result.innerHTML = "";

  const empty = $("lookupEmpty");

  if(!q){
    empty.textContent = "Ch∆∞a c√≥ k·∫øt qu·∫£.";
    empty.style.display = "block";
    return;
  }

  // t√¨m trong master (∆∞u ti√™n), n·∫øu master tr·ªëng th√¨ t√¨m theo locIndex keys
  let pool = state.products.length ? state.products : Object.keys(state.locIndex).map(k=>({name:k, key:k}));

  let scored = pool
    .map(p=>({p, score: scoreMatch(q, p.key)}))
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0, 30);

  if(!scored.length){
    empty.textContent = "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.";
    empty.style.display = "block";
    return;
  }

  empty.style.display = "none";

  scored.forEach(({p})=>{
    const loc = state.locIndex?.[p.key];
    let locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";

    // filter by shelf
    if(shelfFilter){
      if(!loc || loc.shelfId !== shelfFilter) return;
    }

    const item = document.createElement("div");
    item.className = "item";

    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta mono">${escapeHtml(p.key)}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="primary" data-act="jump">üß≠ ƒêi t·ªõi</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî ${locText}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });

    item.querySelector('[data-act="jump"]').addEventListener("click", ()=>{
      if(!loc){ toast("S·∫£n ph·∫©m ch∆∞a g√°n v·ªã tr√≠"); return; }
      // switch tab layout and select shelf/tray
      document.querySelector('.tab[data-tab="layout"]').click();
      $("shelfSelect").value = loc.shelfId;
      ensureTraySelect();
      $("traySelect").value = loc.trayId;
      renderTrayList();
      toast("ƒê√£ m·ªü ƒë√∫ng k·ªá/m√¢m");
    });

    result.appendChild(item);
  });

  if(!result.children.length){
    empty.textContent = "C√≥ k·∫øt qu·∫£ nh∆∞ng kh√¥ng n·∫±m trong k·ªá b·∫°n ƒëang l·ªçc.";
    empty.style.display = "block";
  }
}

$("lookupInput").addEventListener("input", debounce(renderLookup, 180));
$("lookupShelf").addEventListener("change", renderLookup);

/* =========================
   Backup
========================= */
$("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "vi-tri-san-pham-backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("ƒê√£ export JSON");
});

$("importBtn").addEventListener("click", ()=> $("jsonFile").click());
$("jsonFile").addEventListener("change", async ()=>{
  const f = $("jsonFile").files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);

    // basic validation/repair
    if(!obj || typeof obj !== "object") throw new Error("invalid");
    obj.products ??= [];
    obj.shelves ??= [];
    obj.locIndex ??= {};

    state = obj;
    save();
    renderAll();
    toast("ƒê√£ import JSON");
  }catch(e){
    alert("File JSON kh√¥ng h·ª£p l·ªá.");
  }finally{
    $("jsonFile").value = "";
  }
});

$("resetAllBtn").addEventListener("click", ()=>{
  if(!confirm("Xo√° T·∫§T C·∫¢ d·ªØ li·ªáu (SP + k·ªá + v·ªã tr√≠)?")) return;
  state = {products:[], shelves:[], locIndex:{}};
  save();
  renderAll();
  toast("ƒê√£ reset");
});

/* =========================
   Layout render
========================= */
function renderLayout(){
  ensureShelfSelect();
  ensureTraySelect();
  renderTrayList();
  renderLookupShelves();
}

function renderAll(){
  refreshStatus();
  renderLookup();
  renderLayout();
  renderProducts();
}

function renderProductsSafe(){
  renderProducts();
}

/* =========================
   Init
========================= */
load();
save(); // refresh pill
renderAll();
</script>
</body>
</html>
