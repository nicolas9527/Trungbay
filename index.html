<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>V·ªä TR√ç S·∫¢N PH·∫®M</title>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#1976d2;
      --primary2:#64b5f6;
      --danger:#d32f2f;
      --warn:#ef6c00;
      --ok:#1b5e20;
      --border:#e2e8f0;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(25,118,210,.18), transparent 55%),
        radial-gradient(1000px 400px at 90% 0%, rgba(100,181,246,.25), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 12px 25px rgba(25,118,210,.22);
      display:grid;place-items:center;
      color:#fff; font-weight:900;
    }
    .title h1{font-size:18px;margin:0}
    .title p{margin:2px 0 0; color:var(--muted); font-size:13px}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#f1f5f9;border:1px solid var(--border);
      color:var(--muted);font-size:12px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .ok{background:#e8f7ee; color:#14532d; border-color: rgba(27,94,32,.2)}
    .warn{background:#fff4e5; color:#7c2d12; border-color: rgba(239,108,0,.25)}
    .bad{background:#ffe8e8; color:#7f1d1d; border-color: rgba(211,50,47,.25)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      color:#0f172a;
    }
    .tab.active{
      border-color: rgba(25,118,210,.45);
      box-shadow: 0 10px 25px rgba(25,118,210,.12);
      background: linear-gradient(135deg, rgba(25,118,210,.1), rgba(100,181,246,.1));
    }
    .row{display:grid; gap:12px}
    @media (min-width:980px){
      .row{grid-template-columns: 1fr 1fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex; gap:8px; align-items:center;
    }
    .hint{color:var(--muted); font-size:12.5px; margin:0 0 10px;}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px;}
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 12px 12px;
      font-size:15px;
      outline:none;
      transition:.15s;
    }
    textarea{min-height:140px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(25,118,210,.65);
      box-shadow:0 0 0 4px rgba(25,118,210,.12)
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:0; border-radius: 14px;
      padding: 11px 12px;
      font-weight:900;
      cursor:pointer;
      background:#eaf2ff;
      color:#0b3b7a;
    }
    button.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      box-shadow:0 12px 25px rgba(25,118,210,.22);
    }
    button.ghost{background:#f1f5f9; color:#0f172a;}
    button.danger{background:#ffe8e8; color:#7f1d1d;}
    button:active{transform: translateY(1px)}
    .divider{height:1px;background:var(--border); margin:12px 0;}

    .list{display:grid; gap:10px;}
    .item{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:12px;
      background:#fff;
      display:grid; gap:10px;
    }
    .itemTop{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .name{font-weight:900;font-size:15px;line-height:1.25;}
    .meta{margin-top:4px;color:var(--muted);font-size:12.5px;}
    .actions{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;}
    .actions button{padding:9px 10px;border-radius:12px;font-weight:900;font-size:13px;}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .grid2{display:grid; gap:10px; grid-template-columns:1fr;}
    @media (min-width:520px){ .grid2{grid-template-columns:1fr 1fr;} }

    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .tag strong{color:#0f172a}

    /* Tray Grid */
    .gridWrap{
      border:1px solid var(--border);
      border-radius: 18px;
      background:#fff;
      padding:12px;
    }
    .gridHead{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .gridHead .left{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .gridHead .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    @media (min-width:520px){
      .grid{ grid-template-columns: repeat(6, 1fr); }
    }
    @media (min-width:820px){
      .grid{ grid-template-columns: repeat(8, 1fr); }
    }
    .cell{
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px 10px;
      background:#f8fafc;
      cursor:pointer;
      min-height:54px;
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:space-between;
    }
    .cell .pos{
      font-size:12px; color:var(--muted); font-weight:900;
    }
    .cell .pname{
      font-size:12.5px; font-weight:900;
      line-height:1.15;
      color:#0f172a;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .cell.empty .pname{color:var(--muted); font-weight:800}
    .cell.filled{
      background: linear-gradient(135deg, rgba(25,118,210,.08), rgba(100,181,246,.10));
      border-color: rgba(25,118,210,.25);
    }
    .cell.selected{
      outline: 3px solid rgba(25,118,210,.35);
      border-color: rgba(25,118,210,.45);
      background: linear-gradient(135deg, rgba(25,118,210,.12), rgba(100,181,246,.12));
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none; align-items:flex-end; justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(1100px,100%);
      background:#fff;
      border-radius: 18px 18px 0 0;
      padding:14px;
      border:1px solid var(--border);
      box-shadow: 0 -20px 50px rgba(0,0,0,.25);
      max-height: 86vh;
      overflow:auto;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:15px;}
    .xbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(15,23,42,.92); color:#fff;
      padding:10px 14px; border-radius:14px;
      font-weight:900; z-index:99999;
      box-shadow:0 12px 30px rgba(0,0,0,.22);
      opacity:0; pointer-events:none;
      transition: opacity .2s;
    }
    .hidden{display:none !important}

    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      font-size:13px;
      color:#0f172a;
      font-weight:900;
    }
    .toggle input{width:auto}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">VT</div>
      <div class="title">
        <h1>V·ªã tr√≠ s·∫£n ph·∫©m (K·ªá ‚Üí M√¢m ‚Üí V·ªã tr√≠)</h1>
        <p>G√°n nhanh theo th·ª© t·ª± + m√¢m d·∫°ng l∆∞·ªõi v·ªã tr√≠.</p>
      </div>
    </div>
    <div class="pill" id="statusPill">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="lookup">üîé Tra c·ª©u</div>
    <div class="tab" data-tab="layout">üß≠ S∆° ƒë·ªì k·ªá</div>
    <div class="tab" data-tab="products">üì¶ Danh s√°ch s·∫£n ph·∫©m</div>
    <div class="tab" data-tab="backup">üõü Sao l∆∞u</div>
  </div>

  <!-- LOOKUP -->
  <div id="tab-lookup" class="card">
    <h2>Tra c·ª©u v·ªã tr√≠ theo t√™n s·∫£n ph·∫©m</h2>
    <p class="hint">G√µ t√™n (c√≥ th·ªÉ g√µ m·ªôt ph·∫ßn). K·∫øt qu·∫£ s·∫Ω hi·ªán v·ªã tr√≠ ch√≠nh x√°c: K·ªá ‚Ä¢ M√¢m ‚Ä¢ V·ªã tr√≠.</p>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m</label>
        <input id="lookupInput" placeholder="VD: m√¨ h·∫£o h·∫£o..." autocomplete="off"/>
      </div>
      <div>
        <label>L·ªçc theo k·ªá (tu·ª≥ ch·ªçn)</label>
        <select id="lookupShelf">
          <option value="">T·∫•t c·∫£ k·ªá</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>
    <div id="lookupResult" class="list"></div>
    <p id="lookupEmpty" class="small">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>
  </div>

  <!-- LAYOUT -->
  <div id="tab-layout" class="hidden">
    <div class="row">
      <div class="card">
        <h2>T·∫°o / qu·∫£n l√Ω k·ªá</h2>

        <div class="grid2">
          <div>
            <label>T√™n k·ªá</label>
            <input id="newShelfName" placeholder="VD: K·ªá 30" />
          </div>
          <div>
            <label>S·ªë m√¢m trong k·ªá</label>
            <input id="newShelfTrays" inputmode="numeric" placeholder="VD: 5" value="5" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>S·ªë v·ªã tr√≠ m·ªói m√¢m (√¥ l∆∞·ªõi)</label>
            <input id="newShelfSlots" inputmode="numeric" placeholder="VD: 30" value="30" />
          </div>
          <div>
            <label>G·ª£i √Ω</label>
            <div class="pill warn">B·∫°n c√≥ th·ªÉ ƒë·ªïi s·ªë v·ªã tr√≠ sau (trong k·ªá ƒë√£ t·∫°o)</div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="createShelfBtn">‚ûï T·∫°o k·ªá</button>
          <button class="ghost" id="renameShelfBtn">‚úèÔ∏è ƒê·ªïi t√™n k·ªá</button>
          <button class="ghost" id="changeSlotsBtn">üî¢ ƒê·ªïi s·ªë v·ªã tr√≠/m√¢m</button>
          <button class="danger" id="deleteShelfBtn">üóëÔ∏è Xo√° k·ªá</button>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label>Ch·ªçn k·ªá</label>
            <select id="shelfSelect"></select>
          </div>
          <div>
            <label>Ch·ªçn m√¢m</label>
            <select id="traySelect"></select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="openAssignBtn">‚ö° G√°n nhanh (ch·∫°m SP = +1 v·ªã tr√≠)</button>
          <button class="ghost" id="trayRenameBtn">‚úèÔ∏è ƒê·ªïi t√™n m√¢m</button>
          <button class="danger" id="trayClearBtn">üßπ Xo√° to√†n b·ªô SP trong m√¢m</button>
        </div>

        <p class="small" id="layoutInfo" style="margin-top:10px;"></p>
      </div>

      <div class="card">
        <h2>M√¢m d·∫°ng l∆∞·ªõi v·ªã tr√≠</h2>
        <p class="hint">
          Ch·∫°m v√†o √¥ ƒë·ªÉ ch·ªçn v·ªã tr√≠. Sau ƒë√≥ b·∫•m <b>G√°n nhanh</b> ƒë·ªÉ g√°n t·ª´ √¥ ƒë√≥ (ho·∫∑c t·ª´ v·ªã tr√≠ tr·ªëng ti·∫øp theo).
        </p>

        <div class="gridWrap">
          <div class="gridHead">
            <div class="left" id="gridTags"></div>
            <div class="right">
              <span class="tag">ƒê√£ g√°n: <strong id="assignedCount">0</strong></span>
              <span class="tag">Tr·ªëng: <strong id="emptyCount">0</strong></span>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>T√¨m nhanh trong m√¢m</label>
              <input id="traySearch" placeholder="g√µ ƒë·ªÉ l·ªçc list b√™n d∆∞·ªõi..." autocomplete="off"/>
            </div>
            <div>
              <label>S·∫Øp x·∫øp list</label>
              <select id="traySort">
                <option value="posAsc">V·ªã tr√≠ ‚Üë</option>
                <option value="posDesc">V·ªã tr√≠ ‚Üì</option>
                <option value="nameAsc">T√™n A‚ÜíZ</option>
                <option value="nameDesc">T√™n Z‚ÜíA</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div id="trayGrid" class="grid"></div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <div class="pill" id="selectedInfo">Ch∆∞a ch·ªçn √¥</div>
            </div>
            <div class="btns" style="justify-content:flex-end;margin-top:0">
              <button class="ghost" id="copySelectedBtn">üìã Copy</button>
              <button class="ghost" id="replaceSelectedBtn">üîÅ Thay SP</button>
              <button class="danger" id="clearSelectedBtn">üóëÔ∏è Xo√° √¥</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <h2>Danh s√°ch trong m√¢m (d·∫°ng list)</h2>
        <div id="trayList" class="list"></div>
        <p id="trayEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m trong m√¢m n√†y.</p>
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="tab-products" class="hidden">
    <div class="row">
      <div class="card">
        <h2>Nh·∫≠p danh s√°ch s·∫£n ph·∫©m (master)</h2>
        <p class="hint">M·ªói d√≤ng 1 s·∫£n ph·∫©m. V√≠ d·ª•: <b>M√å H·∫¢O H·∫¢O T√îM CHUA CAY 75G</b></p>
        <textarea id="productTextarea" placeholder="D√°n danh s√°ch s·∫£n ph·∫©m v√†o ƒë√¢y..."></textarea>
        <div class="btns">
          <button class="primary" id="addProductsBtn">‚úÖ Th√™m / c·∫≠p nh·∫≠t danh s√°ch</button>
          <button class="ghost" id="importCSVBtn">‚¨ÜÔ∏è Import CSV</button>
          <input id="csvFile" type="file" accept=".csv" class="hidden" />
          <button class="danger" id="clearProductsBtn">üóëÔ∏è Xo√° danh s√°ch SP</button>
        </div>
        <p class="small" id="productStats"></p>
      </div>

      <div class="card">
        <h2>Danh s√°ch s·∫£n ph·∫©m hi·ªán c√≥</h2>
        <div class="grid2">
          <div>
            <label>T√¨m trong master</label>
            <input id="masterSearch" placeholder="g√µ ƒë·ªÉ l·ªçc..." autocomplete="off"/>
          </div>
          <div>
            <label>Hi·ªÉn th·ªã</label>
            <select id="masterLimit">
              <option value="50">50 d√≤ng</option>
              <option value="150">150 d√≤ng</option>
              <option value="500">500 d√≤ng</option>
            </select>
          </div>
        </div>
        <div class="divider"></div>
        <div id="masterList" class="list"></div>
        <p id="masterEmpty" class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m. H√£y nh·∫≠p danh s√°ch ·ªü b√™n tr√°i.</p>
      </div>
    </div>
  </div>

  <!-- BACKUP -->
  <div id="tab-backup" class="card hidden">
    <h2>Sao l∆∞u / kh√¥i ph·ª•c</h2>
    <p class="hint">D·ªØ li·ªáu l∆∞u trong m√°y (localStorage). B·∫°n n√™n export JSON ƒë·ªÉ backup.</p>

    <div class="btns">
      <button class="primary" id="exportBtn">‚¨áÔ∏è Export JSON</button>
      <button class="ghost" id="importBtn">‚¨ÜÔ∏è Import JSON</button>
      <input id="jsonFile" type="file" accept=".json" class="hidden" />
      <button class="danger" id="resetAllBtn">üß® Xo√° t·∫•t c·∫£ d·ªØ li·ªáu</button>
    </div>

    <div class="divider"></div>
    <p class="small mono" id="backupInfo"></p>
  </div>
</div>

<!-- MODAL: Quick assign -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">G√°n nhanh</h3>
      <button class="xbtn" id="closeModal">‚úï</button>
    </div>

    <div class="grid2">
      <div>
        <label>T√¨m s·∫£n ph·∫©m (master)</label>
        <input id="modalSearch" placeholder="g√µ t√™n s·∫£n ph·∫©m..." autocomplete="off"/>
      </div>

      <div>
        <label>V·ªã tr√≠ b·∫Øt ƒë·∫ßu</label>
        <input id="modalPos" inputmode="numeric" placeholder="VD: 1" />
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="toggle">
        <input type="checkbox" id="skipUsedToggle" checked />
        <span>Lu√¥n nh·∫£y t·ªõi <b>v·ªã tr√≠ tr·ªëng</b> (t·ª± b·ªè qua √¥ ƒë√£ c√≥)</span>
      </div>
      <div class="toggle">
        <input type="checkbox" id="autoCloseToggle" />
        <span>T·ª± ƒë√≥ng khi g√°n xong (tu·ª≥ b·∫°n)</span>
      </div>
    </div>

    <p class="hint" style="margin-top:10px">
      ‚úÖ Ch·∫ø ƒë·ªô g√°n nhanh: <b>ch·∫°m s·∫£n ph·∫©m</b> ‚Üí g√°n v√†o v·ªã tr√≠ hi·ªán t·∫°i ‚Üí t·ª± tƒÉng l√™n v·ªã tr√≠ ti·∫øp theo.
    </p>

    <div class="divider"></div>
    <div id="modalPickList" class="list"></div>
    <p id="modalEmpty" class="small">G√µ ƒë·ªÉ t√¨m s·∫£n ph·∫©m r·ªìi ch·∫°m ƒë·ªÉ g√°n.</p>

    <div class="divider"></div>
    <div class="btns">
      <button class="ghost" id="undoAssignBtn">‚Ü©Ô∏è Ho√†n t√°c 1 b∆∞·ªõc</button>
      <button class="primary" id="finishAssignBtn">‚úÖ Xong</button>
    </div>
    <p class="small" id="modalNote" style="margin-top:10px;"></p>
  </div>
</div>

<div id="toast">OK</div>

<script>
/* =========================
   Data model
========================= */
const LS_KEY = "vitri_sanpham_v2_grid";

function removeAccents(str){
  return (str || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}
function norm(str){
  const s = String(str ?? "").trim().replace(/\s+/g," ");
  return removeAccents(s).toUpperCase();
}
function uid(prefix="ID"){
  return prefix + "_" + Math.random().toString(36).slice(2,10).toUpperCase();
}
function debounce(fn, ms=200){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function toInt(v){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : null;
}

let state = {
  products: [], // [{id, name, key}]
  shelves: [],  // [{id, name, positionsPerTray, trays:[{id,name, slots:[{pos, productKey}]}]}]
  locIndex: {}  // productKey -> {shelfId, trayId, pos}
};

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      state = JSON.parse(raw);
      state.products ??= [];
      state.shelves ??= [];
      state.locIndex ??= {};
    }
  }catch(e){}
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  refreshStatus();
}

/* =========================
   UI helpers
========================= */
const $ = (id)=>document.getElementById(id);

const statusPill = $("statusPill");
function refreshStatus(){
  const p = state.products.length;
  const s = state.shelves.length;
  const a = Object.keys(state.locIndex || {}).length;

  statusPill.className = "pill " + (a ? "ok" : (p || s ? "warn" : ""));
  statusPill.textContent = `SP: ${p} ‚Ä¢ K·ªá: ${s} ‚Ä¢ ƒê√£ g√°n: ${a}`;
  $("backupInfo").textContent = `products=${p}, shelves=${s}, assigned=${a}, key=${LS_KEY}`;
}

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.opacity="0", 1100);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const key = tab.dataset.tab;
    ["lookup","layout","products","backup"].forEach(k=>{
      const el = $("tab-"+k);
      if(k===key) el.classList.remove("hidden");
      else el.classList.add("hidden");
    });
    renderAll();
  });
});

/* =========================
   Products (master)
========================= */
function mergeProductsFromLines(lines){
  const set = new Map(state.products.map(p=>[p.key, p]));
  let added=0;
  for(const line of lines){
    const name = String(line ?? "").trim();
    if(!name) continue;
    const key = norm(name);
    if(!key) continue;
    if(!set.has(key)){
      const obj = {id: uid("SP"), name, key};
      set.set(key, obj);
      added++;
    }
  }
  state.products = Array.from(set.values())
    .sort((a,b)=>a.name.localeCompare(b.name,"vi"));
  save();
  toast(`ƒê√£ c·∫≠p nh·∫≠t danh s√°ch (+${added})`);
}

$("addProductsBtn").addEventListener("click", ()=>{
  const lines = $("productTextarea").value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(!lines.length){ toast("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ th√™m"); return; }
  mergeProductsFromLines(lines);
  $("productTextarea").value = "";
  renderProducts();
  renderLookup();
});

$("clearProductsBtn").addEventListener("click", ()=>{
  if(!state.products.length){ toast("Danh s√°ch SP ƒëang tr·ªëng"); return; }
  if(confirm("Xo√° to√†n b·ªô danh s√°ch s·∫£n ph·∫©m (master)?")){
    state.products = [];
    save();
    renderProducts();
    renderLookup();
    toast("ƒê√£ xo√° danh s√°ch SP");
  }
});

$("importCSVBtn").addEventListener("click", ()=> $("csvFile").click());

$("csvFile").addEventListener("change", async ()=>{
  const f = $("csvFile").files?.[0];
  if(!f) return;
  const text = await f.text();
  const lines = parseCSVToNames(text);
  mergeProductsFromLines(lines);
  $("csvFile").value = "";
  renderProducts();
  renderLookup();
});

function parseCSVToNames(text){
  const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  if(!lines.length) return [];
  const parseLine = (line)=>{
    const out=[];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch === "," && !inQ){
        out.push(cur); cur="";
      }else cur += ch;
    }
    out.push(cur);
    return out.map(x=>x.trim());
  };

  const header = parseLine(lines[0]).map(h=>removeAccents(h).toLowerCase());
  let idx = 0;
  const nameIdx = header.findIndex(h=> h.includes("ten") || h.includes("name") || h.includes("product"));
  if(nameIdx >= 0) idx = nameIdx;

  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols = parseLine(lines[i]);
    const name = cols[idx] ?? cols[0] ?? "";
    if(String(name).trim()) out.push(String(name).trim());
  }
  return out;
}

function renderProducts(){
  const q = norm($("masterSearch").value);
  const limit = parseInt($("masterLimit").value,10) || 50;

  let arr = state.products;
  if(q){
    arr = arr.filter(p=> p.key.includes(q));
  }

  $("productStats").textContent = `T·ªïng s·∫£n ph·∫©m: ${state.products.length} ‚Ä¢ ƒêang hi·ªÉn th·ªã: ${Math.min(arr.length, limit)}`;

  const list = $("masterList");
  list.innerHTML = "";
  $("masterEmpty").style.display = state.products.length ? "none" : "block";

  arr.slice(0, limit).forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta mono">${p.key}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
        </div>
      </div>
    `;
    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî ${locText}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });
    list.appendChild(item);
  });
}

$("masterSearch").addEventListener("input", debounce(renderProducts, 200));
$("masterLimit").addEventListener("change", renderProducts);

/* =========================
   Shelves / trays / slots
========================= */
function ensureShelfSelect(){
  const sel = $("shelfSelect");
  sel.innerHTML = "";
  if(!state.shelves.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ k·ªá";
    sel.appendChild(op);
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  if(!sel.value) sel.value = state.shelves[0].id;
}

function ensureTraySelect(){
  const shelfId = $("shelfSelect").value;
  const traySel = $("traySelect");
  traySel.innerHTML = "";
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf || !shelf.trays?.length){
    const op = document.createElement("option");
    op.value = ""; op.textContent = "Ch∆∞a c√≥ m√¢m";
    traySel.appendChild(op);
    traySel.disabled = true;
    return;
  }
  traySel.disabled = false;
  shelf.trays.forEach(t=>{
    const op = document.createElement("option");
    op.value = t.id;
    op.textContent = t.name;
    traySel.appendChild(op);
  });
  if(!traySel.value) traySel.value = shelf.trays[0].id;
}

function createShelf(name, trayCount, slotsPerTray){
  const n = String(name ?? "").trim();
  if(!n){ toast("Nh·∫≠p t√™n k·ªá"); return; }
  const count = Math.max(1, toInt(trayCount) ?? 5);
  const slots = Math.max(1, toInt(slotsPerTray) ?? 30);

  const trays = Array.from({length: count}, (_,i)=>({
    id: uid("MAM"),
    name: `M√¢m ${i+1}`,
    slots: []
  }));

  state.shelves.push({
    id: uid("KE"),
    name: n,
    positionsPerTray: slots,
    trays
  });
  save();
  toast("ƒê√£ t·∫°o k·ªá");
}

$("createShelfBtn").addEventListener("click", ()=>{
  createShelf($("newShelfName").value, $("newShelfTrays").value, $("newShelfSlots").value);
  $("newShelfName").value = "";
  renderLayout();
  renderLookup();
});

$("renameShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }
  const n = prompt("ƒê·ªïi t√™n k·ªá:", shelf.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  shelf.name = nn;
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ ƒë·ªïi t√™n k·ªá");
});

$("changeSlotsBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }
  const n = prompt("S·ªë v·ªã tr√≠ m·ªói m√¢m (√¥ l∆∞·ªõi):", String(shelf.positionsPerTray ?? 30));
  if(n===null) return;
  const slots = toInt(n);
  if(slots===null || slots<=0){ toast("S·ªë kh√¥ng h·ª£p l·ªá"); return; }
  shelf.positionsPerTray = slots;
  save();
  renderTrayGrid();
  toast("ƒê√£ ƒë·ªïi s·ªë v·ªã tr√≠/m√¢m");
});

$("deleteShelfBtn").addEventListener("click", ()=>{
  const shelfId = $("shelfSelect").value;
  const shelf = state.shelves.find(s=>s.id===shelfId);
  if(!shelf){ toast("Ch∆∞a ch·ªçn k·ªá"); return; }

  const assignedInShelf = countAssignedInShelf(shelfId);
  const msg = assignedInShelf
    ? `K·ªá n√†y ƒëang c√≥ ${assignedInShelf} SP ƒë√£ g√°n. Xo√° k·ªá s·∫Ω xo√° lu√¥n c√°c v·ªã tr√≠ ƒë√≥. Ti·∫øp t·ª•c?`
    : "Xo√° k·ªá n√†y?";

  if(!confirm(msg)) return;

  // remove assignments in this shelf
  const keysToRemove = Object.keys(state.locIndex).filter(k=>state.locIndex[k].shelfId === shelfId);
  keysToRemove.forEach(k=> delete state.locIndex[k]);

  state.shelves = state.shelves.filter(s=>s.id!==shelfId);
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ xo√° k·ªá");
});

function countAssignedInShelf(shelfId){
  let c=0;
  for(const k in state.locIndex){
    if(state.locIndex[k].shelfId === shelfId) c++;
  }
  return c;
}

$("shelfSelect").addEventListener("change", ()=>{
  ensureTraySelect();
  selectedPos = null;
  renderTrayGrid();
  renderTrayList();
  renderLookupShelves();
});

$("traySelect").addEventListener("change", ()=>{
  selectedPos = null;
  renderTrayGrid();
  renderTrayList();
});

$("trayRenameBtn").addEventListener("click", ()=>{
  const tray = getSelectedTray();
  if(!tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }
  const n = prompt("ƒê·ªïi t√™n m√¢m:", tray.name);
  if(n===null) return;
  const nn = n.trim();
  if(!nn){ toast("T√™n kh√¥ng h·ª£p l·ªá"); return; }
  tray.name = nn;
  save();
  renderLayout();
  renderLookup();
  toast("ƒê√£ ƒë·ªïi t√™n m√¢m");
});

$("trayClearBtn").addEventListener("click", ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Ch∆∞a ch·ªçn m√¢m"); return; }

  const count = tray.slots.length;
  if(!count){ toast("M√¢m ƒëang tr·ªëng"); return; }
  if(!confirm(`Xo√° to√†n b·ªô ${count} SP trong ${shelf.name} - ${tray.name}?`)) return;

  tray.slots.forEach(sl=>{
    if(state.locIndex[sl.productKey]) delete state.locIndex[sl.productKey];
  });
  tray.slots = [];
  selectedPos = null;
  save();
  renderTrayGrid();
  renderTrayList();
  renderLookup();
  toast("ƒê√£ xo√° SP trong m√¢m");
});

function getSelectedShelf(){
  const id = $("shelfSelect").value;
  return state.shelves.find(s=>s.id===id);
}
function getSelectedTray(){
  const shelf = getSelectedShelf();
  if(!shelf) return null;
  const tid = $("traySelect").value;
  return shelf.trays.find(t=>t.id===tid);
}

function formatLoc(loc){
  const shelf = state.shelves.find(s=>s.id===loc.shelfId);
  const tray = shelf?.trays?.find(t=>t.id===loc.trayId);
  const shelfName = shelf?.name ?? "(k·ªá ƒë√£ xo√°)";
  const trayName = tray?.name ?? "(m√¢m ƒë√£ xo√°)";
  return `${shelfName} ‚Ä¢ ${trayName} ‚Ä¢ V·ªã tr√≠ ${loc.pos}`;
}

/* =========================
   Tray Grid
========================= */
let selectedPos = null;

function getNextFreePos(tray, startPos){
  const used = new Set((tray.slots || []).map(s => s.pos));
  let p = Math.max(1, startPos || 1);
  while(used.has(p)) p++;
  return p;
}

function productNameByKey(key){
  return state.products.find(p=>p.key===key)?.name ?? key;
}

function slotAtPos(tray, pos){
  return (tray.slots || []).find(s=>s.pos === pos) || null;
}

function removeProductFromOldLocation(productKey){
  const oldLoc = state.locIndex[productKey];
  if(!oldLoc) return null;

  const oldShelf = state.shelves.find(s=>s.id===oldLoc.shelfId);
  const oldTray  = oldShelf?.trays?.find(t=>t.id===oldLoc.trayId);
  if(oldTray){
    oldTray.slots = oldTray.slots.filter(sl=>sl.productKey !== productKey);
  }
  return oldLoc;
}

function clearPosInCurrentTray(pos){
  const tray = getSelectedTray();
  if(!tray) return;
  const sl = slotAtPos(tray, pos);
  if(!sl){ toast("√î ƒëang tr·ªëng"); return; }
  if(!confirm(`Xo√° "${productNameByKey(sl.productKey)}" kh·ªèi v·ªã tr√≠ ${pos}?`)) return;

  tray.slots = tray.slots.filter(s=>s.pos !== pos);
  delete state.locIndex[sl.productKey];
  save();
  renderTrayGrid();
  renderTrayList();
  renderLookup();
  toast("ƒê√£ xo√° √¥");
}

function renderTrayGrid(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  const grid = $("trayGrid");
  grid.innerHTML = "";

  if(!shelf || !tray){
    $("gridTags").innerHTML = "";
    $("assignedCount").textContent = "0";
    $("emptyCount").textContent = "0";
    $("selectedInfo").textContent = "Ch∆∞a ch·ªçn √¥";
    return;
  }

  const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
  const used = new Map(tray.slots.map(s=>[s.pos, s.productKey]));
  const assigned = used.size;
  const empty = Math.max(0, maxPos - assigned);

  $("assignedCount").textContent = String(assigned);
  $("emptyCount").textContent = String(empty);

  $("gridTags").innerHTML = `
    <span class="tag"><strong>${escapeHtml(shelf.name)}</strong></span>
    <span class="tag"><strong>${escapeHtml(tray.name)}</strong></span>
    <span class="tag">√î: <strong>${maxPos}</strong></span>
  `;

  for(let pos=1; pos<=maxPos; pos++){
    const key = used.get(pos);
    const cell = document.createElement("div");
    const isFilled = !!key;
    cell.className = "cell " + (isFilled ? "filled" : "empty") + (selectedPos===pos ? " selected" : "");
    cell.innerHTML = `
      <div class="pos">#${pos}</div>
      <div class="pname">${isFilled ? escapeHtml(productNameByKey(key)) : "Tr·ªëng"}</div>
    `;
    cell.addEventListener("click", ()=>{
      selectedPos = pos;
      updateSelectedInfo();
      renderTrayGrid();
    });
    grid.appendChild(cell);
  }

  if(selectedPos === null || selectedPos < 1 || selectedPos > maxPos) selectedPos = null;
  updateSelectedInfo();
}

function updateSelectedInfo(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray || selectedPos === null){
    $("selectedInfo").className = "pill";
    $("selectedInfo").textContent = "Ch∆∞a ch·ªçn √¥";
    return;
  }
  const sl = slotAtPos(tray, selectedPos);
  if(!sl){
    $("selectedInfo").className = "pill warn";
    $("selectedInfo").textContent = `ƒêang ch·ªçn: V·ªã tr√≠ ${selectedPos} (TR·ªêNG)`;
  }else{
    $("selectedInfo").className = "pill ok";
    $("selectedInfo").textContent = `ƒêang ch·ªçn: V·ªã tr√≠ ${selectedPos} ‚Ä¢ ${productNameByKey(sl.productKey)}`;
  }
}

$("clearSelectedBtn").addEventListener("click", ()=>{
  if(selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  clearPosInCurrentTray(selectedPos);
});

$("copySelectedBtn").addEventListener("click", async ()=>{
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray || selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  const sl = slotAtPos(tray, selectedPos);
  const text = sl
    ? `${productNameByKey(sl.productKey)} ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${selectedPos}`
    : `√î tr·ªëng ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${selectedPos}`;
  try{ await navigator.clipboard.writeText(text); toast("ƒê√£ copy"); }
  catch(e){ alert(text); }
});

$("replaceSelectedBtn").addEventListener("click", ()=>{
  if(selectedPos===null){ toast("Ch∆∞a ch·ªçn √¥"); return; }
  openAssignModal({ startPos: selectedPos });
});

/* =========================
   Quick Assign Modal (tap product => assign + pos++)
========================= */
let modalAssignPos = 1;
let modalAssignedCount = 0;
let modalHistory = []; // for undo
let modalStartPosLocked = null; // if opened from a selected cell replace

function openAssignModal(opts = {}){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){
    toast("C·∫ßn ch·ªçn k·ªá v√† m√¢m tr∆∞·ªõc");
    return;
  }

  modalHistory = [];
  modalAssignedCount = 0;

  modalStartPosLocked = (typeof opts.startPos === "number" && opts.startPos > 0) ? opts.startPos : null;

  $("modalTitle").textContent = `G√°n nhanh: ${shelf.name} ‚Üí ${tray.name}`;

  $("modalSearch").value = "";
  $("modalPickList").innerHTML = "";
  $("modalEmpty").style.display = "block";

  // v·ªã tr√≠ b·∫Øt ƒë·∫ßu:
  const basePos = modalStartPosLocked ?? (selectedPos ?? 1);
  const skipUsed = $("skipUsedToggle").checked;
  modalAssignPos = skipUsed ? getNextFreePos(tray, basePos) : Math.max(1, basePos);
  $("modalPos").value = String(modalAssignPos);

  $("modalNote").innerHTML =
    `V·ªã tr√≠ b·∫Øt ƒë·∫ßu: <b>${modalAssignPos}</b> ‚Ä¢ Ch·∫°m SP ƒë·ªÉ g√°n.`;

  $("modalBack").style.display = "flex";
  setTimeout(()=> $("modalSearch").focus(), 50);
}

function closeAssignModal(){
  $("modalBack").style.display = "none";
  modalStartPosLocked = null;
}

$("openAssignBtn").addEventListener("click", ()=> openAssignModal({}));

$("closeModal").addEventListener("click", closeAssignModal);
$("finishAssignBtn").addEventListener("click", ()=>{
  closeAssignModal();
  toast("ƒê√£ l∆∞u v·ªã tr√≠");
});
$("modalBack").addEventListener("click", (e)=>{
  if(e.target === $("modalBack")) closeAssignModal();
});

function assignQuick(productKey){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  if(!shelf || !tray){ toast("Thi·∫øu k·ªá/m√¢m"); return; }

  const typed = toInt($("modalPos").value);
  if(typed !== null) modalAssignPos = typed;

  const skipUsed = $("skipUsedToggle").checked;

  // N·∫øu m·ªü ƒë·ªÉ thay √¥ ƒëang ch·ªçn: v·∫´n cho g√°n theo th·ª© t·ª± t·ª´ √¥ ƒë√≥ (nh∆∞ng s·∫Ω nh·∫£y √¥ tr·ªëng n·∫øu b·∫≠t skip)
  const pos = skipUsed ? getNextFreePos(tray, modalAssignPos) : Math.max(1, modalAssignPos);

  // N·∫øu pos v∆∞·ª£t qu√° s·ªë √¥/m√¢m th√¨ c·∫£nh b√°o
  const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
  if(pos > maxPos){
    toast("V·ªã tr√≠ v∆∞·ª£t s·ªë √¥ c·ªßa m√¢m");
    $("modalNote").innerHTML = `‚ö†Ô∏è V·ªã tr√≠ <b>${pos}</b> v∆∞·ª£t s·ªë √¥ (<b>${maxPos}</b>). H√£y tƒÉng "S·ªë v·ªã tr√≠/m√¢m" ho·∫∑c ƒë·ªïi v·ªã tr√≠ b·∫Øt ƒë·∫ßu.`;
    return;
  }

  // n·∫øu √¥ ƒëang c√≥ sp kh√°c -> thay tr·ª±c ti·∫øp
  const existedSlot = slotAtPos(tray, pos);
  let replacedKey = null;
  if(existedSlot && existedSlot.productKey !== productKey){
    replacedKey = existedSlot.productKey;
    tray.slots = tray.slots.filter(s=>s.pos !== pos);
    delete state.locIndex[replacedKey];
  }

  // n·∫øu sp ƒë√£ c√≥ v·ªã tr√≠ kh√°c -> t·ª± chuy·ªÉn (kh√¥ng h·ªèi)
  const oldLoc = state.locIndex[productKey] ? {...state.locIndex[productKey]} : null;
  removeProductFromOldLocation(productKey);

  tray.slots.push({pos, productKey});
  tray.slots.sort((a,b)=>a.pos-b.pos);
  state.locIndex[productKey] = {shelfId: shelf.id, trayId: tray.id, pos};

  modalHistory.push({
    productKey,
    newLoc: {shelfId: shelf.id, trayId: tray.id, pos},
    oldLoc,
    replacedKey
  });

  save();

  modalAssignedCount++;
  // next position:
  modalAssignPos = pos + 1;
  $("modalPos").value = String(modalAssignPos);

  const prodName = productNameByKey(productKey);
  $("modalNote").innerHTML = `ƒê√£ g√°n <b>${escapeHtml(prodName)}</b> ‚Üí V·ªã tr√≠ <b>${pos}</b> ‚Ä¢ T·ªïng ƒë√£ g√°n: <b>${modalAssignedCount}</b>`;
  toast(`G√°n v·ªã tr√≠ ${pos}`);

  // refresh tray ui
  selectedPos = pos;
  renderTrayGrid();
  renderTrayList();
  renderLookup();

  if($("autoCloseToggle").checked){
    closeAssignModal();
  }
}

$("undoAssignBtn").addEventListener("click", ()=>{
  const last = modalHistory.pop();
  if(!last){ toast("Kh√¥ng c√≥ g√¨ ƒë·ªÉ ho√†n t√°c"); return; }

  const newShelf = state.shelves.find(s=>s.id===last.newLoc.shelfId);
  const newTray  = newShelf?.trays?.find(t=>t.id===last.newLoc.trayId);
  if(newTray){
    newTray.slots = newTray.slots.filter(sl=> !(sl.productKey===last.productKey && sl.pos===last.newLoc.pos));
  }

  // restore replacedKey (n·∫øu c√≥)
  if(last.replacedKey){
    const rOldLoc = null; // tr∆∞·ªõc ƒë√≥ n√≥ n·∫±m ·ªü pos last.newLoc.pos trong tray n√†y
    // ƒë∆∞a l·∫°i v√†o tray:
    newTray?.slots?.push({pos:last.newLoc.pos, productKey:last.replacedKey});
    newTray?.slots?.sort((a,b)=>a.pos-b.pos);
    if(newShelf && newTray){
      state.locIndex[last.replacedKey] = {shelfId:newShelf.id, trayId:newTray.id, pos:last.newLoc.pos};
    }
  }

  // restore old location of productKey (if any)
  if(last.oldLoc){
    const oldShelf = state.shelves.find(s=>s.id===last.oldLoc.shelfId);
    const oldTray  = oldShelf?.trays?.find(t=>t.id===last.oldLoc.trayId);
    if(oldTray){
      oldTray.slots.push({pos:last.oldLoc.pos, productKey:last.productKey});
      oldTray.slots.sort((a,b)=>a.pos-b.pos);
    }
    state.locIndex[last.productKey] = last.oldLoc;
  }else{
    delete state.locIndex[last.productKey];
  }

  save();
  modalAssignedCount = Math.max(0, modalAssignedCount-1);

  const curTray = getSelectedTray();
  if(curTray){
    const typed = toInt($("modalPos").value);
    // ƒë∆∞a v·ªÅ v·ªã tr√≠ tr·ªëng g·∫ßn nh·∫•t t·ª´ (typed-1) ƒë·ªÉ g√°n ti·∫øp
    modalAssignPos = Math.max(1, (typed ?? (last.newLoc.pos+1)) - 1);
    if($("skipUsedToggle").checked) modalAssignPos = getNextFreePos(curTray, modalAssignPos);
    $("modalPos").value = String(modalAssignPos);
  }

  renderTrayGrid();
  renderTrayList();
  renderLookup();
  toast("ƒê√£ ho√†n t√°c");
});

function renderModalPick(){
  const q = norm($("modalSearch").value);
  const list = $("modalPickList");
  list.innerHTML = "";

  if(!q){
    $("modalEmpty").style.display = "block";
    return;
  }
  $("modalEmpty").style.display = "none";

  const arr = state.products
    .filter(p=>p.key.includes(q))
    .slice(0, 80);

  if(!arr.length){
    const p = document.createElement("p");
    p.className = "small";
    p.textContent = "Kh√¥ng th·∫•y trong danh s√°ch master. (H√£y nh·∫≠p master ·ªü tab Danh s√°ch s·∫£n ph·∫©m)";
    list.appendChild(p);
    return;
  }

  arr.forEach(p=>{
    const loc = state.locIndex?.[p.key];
    const locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta small">üëâ Ch·∫°m ƒë·ªÉ g√°n v√†o v·ªã tr√≠ hi·ªán t·∫°i</div>
        </div>
        <div class="actions">
          <button class="primary">Ch·∫°m ƒë·ªÉ g√°n</button>
        </div>
      </div>
    `;

    const doAssign = ()=> assignQuick(p.key);
    item.addEventListener("click", ()=> doAssign());
    item.querySelector("button").addEventListener("click", (e)=>{ e.stopPropagation(); doAssign(); });

    list.appendChild(item);
  });
}
$("modalSearch").addEventListener("input", debounce(renderModalPick, 180));

/* =========================
   Tray List render
========================= */
function renderTrayList(){
  const shelf = getSelectedShelf();
  const tray = getSelectedTray();
  const list = $("trayList");
  list.innerHTML = "";

  if(!shelf || !tray){
    $("trayEmpty").style.display = "block";
    $("layoutInfo").textContent = "";
    return;
  }

  const q = norm($("traySearch").value);
  const sort = $("traySort").value;

  let arr = tray.slots.slice();
  if(q){
    arr = arr.filter(sl=>{
      const name = productNameByKey(sl.productKey);
      return norm(name).includes(q);
    });
  }

  if(sort==="posAsc") arr.sort((a,b)=>a.pos-b.pos);
  if(sort==="posDesc") arr.sort((a,b)=>b.pos-a.pos);
  if(sort==="nameAsc") arr.sort((a,b)=> productNameByKey(a.productKey).localeCompare(productNameByKey(b.productKey),"vi"));
  if(sort==="nameDesc") arr.sort((a,b)=> productNameByKey(b.productKey).localeCompare(productNameByKey(a.productKey),"vi"));

  $("trayEmpty").style.display = tray.slots.length ? "none" : "block";
  $("layoutInfo").innerHTML = `
    <span class="tag"><strong>${escapeHtml(shelf.name)}</strong></span>
    <span class="tag"><strong>${escapeHtml(tray.name)}</strong></span>
    <span class="tag">T·ªïng SP: <strong>${tray.slots.length}</strong></span>
  `;

  arr.forEach(sl=>{
    const prodName = productNameByKey(sl.productKey);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(prodName)}</div>
          <div class="meta">V·ªã tr√≠: <b>${sl.pos}</b></div>
          <div class="meta mono">${escapeHtml(sl.productKey)}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="ghost" data-act="move">üîÅ ƒê·ªïi v·ªã tr√≠</button>
          <button class="danger" data-act="del">üóëÔ∏è Xo√°</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${prodName} ‚Äî ${shelf.name} / ${tray.name} / V·ªã tr√≠ ${sl.pos}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });

    item.querySelector('[data-act="move"]').addEventListener("click", ()=>{
      const np = prompt(`ƒê·ªïi v·ªã tr√≠ cho "${prodName}" (hi·ªán: ${sl.pos})`, String(sl.pos));
      if(np===null) return;
      const npos = toInt(np);
      if(npos===null || npos<=0){ toast("V·ªã tr√≠ ph·∫£i > 0"); return; }

      const maxPos = Math.max(1, shelf.positionsPerTray ?? 30);
      if(npos > maxPos){ toast("V∆∞·ª£t s·ªë √¥ c·ªßa m√¢m"); return; }

      const existed = slotAtPos(tray, npos);
      if(existed && existed.productKey !== sl.productKey){
        const existedName = productNameByKey(existed.productKey);
        if(!confirm(`V·ªã tr√≠ ${npos} ƒëang c√≥ "${existedName}". Thay th·∫ø?`)) return;
        delete state.locIndex[existed.productKey];
        tray.slots = tray.slots.filter(x=>x.pos!==npos);
      }

      sl.pos = npos;
      tray.slots.sort((a,b)=>a.pos-b.pos);
      state.locIndex[sl.productKey] = {shelfId:shelf.id, trayId:tray.id, pos:npos};
      selectedPos = npos;
      save();
      renderTrayGrid();
      renderTrayList();
      renderLookup();
      toast("ƒê√£ ƒë·ªïi v·ªã tr√≠");
    });

    item.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      if(!confirm(`Xo√° "${prodName}" kh·ªèi ${shelf.name} - ${tray.name}?`)) return;
      tray.slots = tray.slots.filter(x=>x.productKey !== sl.productKey);
      delete state.locIndex[sl.productKey];
      if(selectedPos === sl.pos) selectedPos = null;
      save();
      renderTrayGrid();
      renderTrayList();
      renderLookup();
      toast("ƒê√£ xo√°");
    });

    list.appendChild(item);
  });
}

$("traySearch").addEventListener("input", debounce(renderTrayList, 160));
$("traySort").addEventListener("change", renderTrayList);

/* =========================
   Lookup
========================= */
function renderLookupShelves(){
  const sel = $("lookupShelf");
  const cur = sel.value;
  sel.innerHTML = `<option value="">T·∫•t c·∫£ k·ªá</option>`;
  state.shelves.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = s.name;
    sel.appendChild(op);
  });
  sel.value = cur || "";
}

function scoreMatch(qKey, pKey){
  if(!qKey) return 0;
  if(pKey === qKey) return 1000;
  if(pKey.startsWith(qKey)) return 600 + qKey.length;
  if(pKey.includes(qKey)) return 300 + qKey.length;
  const parts = qKey.split(" ").filter(Boolean);
  let hit=0;
  for(const w of parts) if(pKey.includes(w)) hit++;
  return hit ? (100 + hit*10) : 0;
}

function renderLookup(){
  renderLookupShelves();

  const q = norm($("lookupInput").value);
  const shelfFilter = $("lookupShelf").value;

  const result = $("lookupResult");
  result.innerHTML = "";

  const empty = $("lookupEmpty");

  if(!q){
    empty.textContent = "Ch∆∞a c√≥ k·∫øt qu·∫£.";
    empty.style.display = "block";
    return;
  }

  let pool = state.products.length ? state.products : Object.keys(state.locIndex).map(k=>({name:k, key:k}));

  let scored = pool
    .map(p=>({p, score: scoreMatch(q, p.key)}))
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0, 30);

  if(!scored.length){
    empty.textContent = "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.";
    empty.style.display = "block";
    return;
  }

  empty.style.display = "none";

  scored.forEach(({p})=>{
    const loc = state.locIndex?.[p.key];
    let locText = loc ? formatLoc(loc) : "Ch∆∞a g√°n v·ªã tr√≠";

    if(shelfFilter){
      if(!loc || loc.shelfId !== shelfFilter) return;
    }

    const item = document.createElement("div");
    item.className = "item";

    item.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(locText)}</div>
          <div class="meta mono">${escapeHtml(p.key)}</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="copy">üìã Copy</button>
          <button class="primary" data-act="jump">üß≠ ƒêi t·ªõi</button>
        </div>
      </div>
    `;

    item.querySelector('[data-act="copy"]').addEventListener("click", async ()=>{
      const line = `${p.name} ‚Äî ${locText}`;
      try{ await navigator.clipboard.writeText(line); toast("ƒê√£ copy"); }
      catch(e){ alert(line); }
    });

    item.querySelector('[data-act="jump"]').addEventListener("click", ()=>{
      if(!loc){ toast("S·∫£n ph·∫©m ch∆∞a g√°n v·ªã tr√≠"); return; }
      document.querySelector('.tab[data-tab="layout"]').click();
      $("shelfSelect").value = loc.shelfId;
      ensureTraySelect();
      $("traySelect").value = loc.trayId;
      selectedPos = loc.pos;
      renderTrayGrid();
      renderTrayList();
      toast("ƒê√£ m·ªü ƒë√∫ng k·ªá/m√¢m");
    });

    result.appendChild(item);
  });

  if(!result.children.length){
    empty.textContent = "C√≥ k·∫øt qu·∫£ nh∆∞ng kh√¥ng n·∫±m trong k·ªá b·∫°n ƒëang l·ªçc.";
    empty.style.display = "block";
  }
}

$("lookupInput").addEventListener("input", debounce(renderLookup, 160));
$("lookupShelf").addEventListener("change", renderLookup);

/* =========================
   Backup
========================= */
$("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "vi-tri-san-pham-backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("ƒê√£ export JSON");
});

$("importBtn").addEventListener("click", ()=> $("jsonFile").click());
$("jsonFile").addEventListener("change", async ()=>{
  const f = $("jsonFile").files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!obj || typeof obj !== "object") throw new Error("invalid");
    obj.products ??= [];
    obj.shelves ??= [];
    obj.locIndex ??= {};
    state = obj;
    save();
    renderAll();
    toast("ƒê√£ import JSON");
  }catch(e){
    alert("File JSON kh√¥ng h·ª£p l·ªá.");
  }finally{
    $("jsonFile").value = "";
  }
});

$("resetAllBtn").addEventListener("click", ()=>{
  if(!confirm("Xo√° T·∫§T C·∫¢ d·ªØ li·ªáu (SP + k·ªá + v·ªã tr√≠)?")) return;
  state = {products:[], shelves:[], locIndex:{}};
  save();
  renderAll();
  toast("ƒê√£ reset");
});

/* =========================
   Layout render
========================= */
function renderLayout(){
  ensureShelfSelect();
  ensureTraySelect();
  renderTrayGrid();
  renderTrayList();
  renderLookupShelves();
}

/* =========================
   Init
========================= */
load();
save();
renderProducts();
renderLookup();
renderLayout();
refreshStatus();

function renderAll(){
  refreshStatus();
  renderProducts();
  renderLookup();
  renderLayout();
}
</script>
</body>
</html>
